commands:
  run-trivy-license:
    description: "Run Trivy Scan to Extract License"
    steps:
      - cached-checkout
      - attach_workspace:
          at: ~/
      - restore-maven-cache
      - run:
          name: Install trivy
          command: |
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp/bin
      - run:
          name: Run Trivy
          command: |
            /tmp/bin/trivy fs --scanners license --include-dev-deps  -f json -o ~/project/target/artifacts/licenses-dev-deps.json .
            cat ~/project/target/artifacts/licenses-dev-deps.json| jq '.Results[].Licenses[]? | "\(.PkgName);\(.FilePath);\(.Name)"' | sort | tr -d '"' | uniq > ~/project/target/artifacts/licenses-dev-deps.txt
            cat ~/project/target/artifacts/licenses-dev-deps.json| jq '.Results[].Licenses[]? | "\(.Name)"' | sort | tr -d '"' | uniq > ~/project/target/artifacts/licenses-only.txt 

      - store_artifacts:
          path: ~/project/target/artifacts
          destination: artifacts
      #- persist_to_workspace:
      #    root: ~/
      #    paths:
      #      - project/target/structure-graph.json
      #      - .m2/repository/org/opennms
      #      # is this even necessary anymore?
      #      - .artifacts
