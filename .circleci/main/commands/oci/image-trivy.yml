commands:
  image-trivy:
    parameters:
      architecture:
        type: string
      container_name:
        type: string
      container_dir:
        type: string
      tarball_match:
        type: string
      tarball_path:
        type: string
    steps:
      - setup_remote_docker:
          docker_layer_caching: false
      - cached-checkout
      - download-download-artifacts
      - run:
          name: download tarball dependency to << parameters.tarball_path >>
          command:  |
            export ARCH="$(printf "<< parameters.architecture >>" | tr / -)"
            export TAG="<< parameters.container_name >>-${ARCH}"
            mkdir /tmp/oci
            download-artifacts.pl --include-failed --workflow="${CIRCLE_WORKFLOW_ID}" --match="${TAG}" oci "${CIRCLE_BRANCH}" "/tmp/oci"
            ls -l /tmp/oci
      - run:
          name: Install trivy
          command: |
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp/bin
      - run:
          name: Detect if we should use .trivyignore
          command: |
           if [ -s ~/project/.circleci/trivy-config/trivyignore ]
           then
             echo "creating trivyignore under /tmp/bin/.trivyignore"
             cp ~/project/.circleci/trivy-config/trivyignore /tmp/bin/.trivyignore
             cp ~/project/.circleci/trivy-config/trivyignore ~/project/.trivyignore
             ls -l /tmp/bin/
             cat /tmp/bin/.trivyignore
           fi 
      - run:
          name: Scan the local image with trivy
          command: |
            docker image load -i ~/project/opennms-container/*/images/*.oci
            docker images
            export ARCH="$(printf "<< parameters.architecture >>" | tr / -)"
            export TAG="<< parameters.container_name >>-${ARCH}"
            # Table result includes only package filenames. Use '--format json' option to get the full path to the package file.
            /tmp/bin/trivy image --exit-code 0 --format json -o /tmp/report.json --no-progress opennms/${TAG}
            /tmp/bin/trivy image --exit-code 0 -o /tmp/report.txt --no-progress opennms/${TAG}
      - store_artifacts:
          path: /tmp/report.json
          destination: report.json
      - store_artifacts:
          path: /tmp/report.txt
          destination: report.txt
