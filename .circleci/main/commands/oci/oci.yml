commands:
  cache-oci:
    parameters:
      key:
        description: the cache key for storing the OCI
        type: string
      path:
        description: the path to the directory containing the OCI
        type: string
    steps:
      - cache-workflow-assets:
          cache_prefix: oci-<< parameters.key >>
          source_path: << parameters.path >>
  load-oci:
    parameters:
      key:
        description: the OCI cache key to restore
        type: string
    steps:
      - restore-workflow-assets:
          cache_prefix: oci-<< parameters.key >>
      - run:
          name: Load Docker Image(s) in oci-<< parameters.key >>
          command: |
            cd "/tmp/oci-<< parameters.key >>"
            if [ "$(ls -1 *.oci | wc -l)" -eq 0 ]; then
              echo "ERROR: No OCI files to load. Something probably went wrong earlier."
              exit 1
            fi
            for FILE in *.oci; do
              echo "Loading ${FILE} into Docker..."
              docker image load -i "$FILE"
            done
  build-image-single-arch:
    parameters:
      architecture:
        type: string
      cache_prefix:
        type: string
      container_name:
        type: string
    steps:
      - attach_workspace:
          at: ~/
      - qemu-user-static
      - install-buildx
      - restore-workflow-assets:
          cache_prefix: << parameters.cache_prefix >>
          target_path: "target/debs"
      - run:
          name: Fetch DEB artifacts and build << parameters.container_name >> container image
          command: |
            cd opennms-container/<< parameters.container_name >>
            env DOCKER_ARCH="<< parameters.architecture >>" ./build_container_image.sh
      - store_artifacts:
          path: ~/project/opennms-container/<< parameters.container_name >>/images/container.oci
          destination: << parameters.container_name >>.oci
