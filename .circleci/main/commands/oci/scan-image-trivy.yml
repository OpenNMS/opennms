commands:
  scan-image-trivy:
    parameters:
      architecture:
        type: string
      container_name:
        type: string
      container_dir:
        type: string
      tarball_match:
        type: string
      tarball_path:
        type: string
    steps:
      - setup_remote_docker:
          docker_layer_caching: false
      - cached-checkout
      - download-download-artifacts
      - run:
          name: download tarball dependency to << parameters.tarball_path >>
          command: download-artifacts.pl --include-failed --workflow="${CIRCLE_WORKFLOW_ID}" --match="<< parameters.tarball_match >>" tar.gz "${CIRCLE_BRANCH}" "$(pwd)/<< parameters.tarball_path >>"
      - run:
          name: build << parameters.container_name >>=<< parameters.architecture >> container image
          command: |
            # set up multi-arch
            docker container prune -f
            docker run --rm --privileged tonistiigi/binfmt:latest --install "<< parameters.architecture >>"

            # export DOCKER_CONTENT_TRUST=1
            cd opennms-container/<< parameters.container_dir >>
            export ARCH="$(printf "<< parameters.architecture >>" | tr / -)"
            export TAG="<< parameters.container_name >>-${ARCH}"
            make DOCKER_ARCH="<< parameters.architecture >>" \
                 DOCKER_OCI="images/${TAG}.oci" \
                 DOCKER_TAG="opennms/${TAG}" \
                 BUILD_NUMBER="${CIRCLE_BUILD_NUM}" \
                 BUILD_URL="${CIRCLE_BUILD_URL}" \
                 BUILD_BRANCH="${CIRCLE_BRANCH}" \
                 oci
      - run:
          name: Install trivy
          command: |
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp/bin
      - run:
          name: Scan the local image with trivy
          command: |
            docker image load -i ~/project/opennms-container/*/images/*.oci
            export ARCH="$(printf "<< parameters.architecture >>" | tr / -)"
            export TAG="<< parameters.container_name >>-${ARCH}"
            /tmp/bin/trivy image --severity HIGH,CRITICAL --pkg-types os,library --scanners vuln --ignorefile ~/project/.circleci/trivy-config/trivyignore --timeout 30m --format json -o /tmp/filtered_vulnerabilities.json --no-progress opennms/${TAG}
            /tmp/bin/trivy image --pkg-types os,library --scanners vuln --ignorefile ~/project/.circleci/trivy-config/trivyignore --timeout 30m --format json -o /tmp/report.json --no-progress opennms/${TAG}

            # Rename files to include job name
            JOB_NAME_SANITIZED=$(echo "${CIRCLE_JOB}" | tr / -)
            mkdir -p /tmp/artifacts
            cp /tmp/report.json "/tmp/artifacts/${JOB_NAME_SANITIZED}_report.json"
            cp /tmp/filtered_vulnerabilities.json "/tmp/artifacts/${JOB_NAME_SANITIZED}_filtered_vulnerabilities.json"
      - store_artifacts:
          path: /tmp/artifacts
          destination: trivy-reports

  trivy-analyze:
    steps:
      - run:
          name: Download Trivy scan artifacts
          command: |
            # Remove just the '-analyze' suffix from the job name
            SCAN_JOB_NAME="${CIRCLE_JOB%-analyze}"
            SANITIZED_SCAN_JOB_NAME=$(echo "${SCAN_JOB_NAME}" | tr / -)
            
            echo "Downloading Trivy scan artifacts for job: ${SCAN_JOB_NAME}"
            echo "Looking for files: ${SANITIZED_SCAN_JOB_NAME}_report.json and ${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.json"
            
            # Download artifacts from the trivy-reports directory
            download-artifacts.pl --workflow="${CIRCLE_WORKFLOW_ID}" --match="${SANITIZED_SCAN_JOB_NAME}_*.json" json "${CIRCLE_BRANCH}" "/tmp"
            
            echo "Checking downloaded files in /tmp:"
            ls -l /tmp
            
            # Create symlinks to expected filenames for backward compatibility
            if [[ -f "/tmp/${SANITIZED_SCAN_JOB_NAME}_report.json" ]]; then
              ln -s "/tmp/${SANITIZED_SCAN_JOB_NAME}_report.json" "/tmp/report.json"
            else
              echo "Error: /tmp/${SANITIZED_SCAN_JOB_NAME}_report.json not found!"
              exit 1
            fi
            
            if [[ -f "/tmp/${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.json" ]]; then
              ln -s "/tmp/${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.json" "/tmp/filtered_vulnerabilities.json"
            else
              echo "Error: /tmp/${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.json not found!"
              exit 1
            fi
      - run:
          name: Analyze Trivy scan results
          command: |
            echo "Analyzing Trivy scan results..."
            python3 .circleci/pyscripts/analyze_trivy_report.py /tmp/report.json
            
            # Rename output files to include job name
            SCAN_JOB_NAME="${CIRCLE_JOB%-analyze}"
            SANITIZED_SCAN_JOB_NAME=$(echo "${SCAN_JOB_NAME}" | tr / -)
            mv report.txt "${SANITIZED_SCAN_JOB_NAME}_report.txt"
            mv report.csv "${SANITIZED_SCAN_JOB_NAME}_report.csv"
      - store_artifacts:
          path: "*_report.txt"
          destination: trivy-reports
      - store_artifacts:
          path: "*_report.csv"
          destination: trivy-reports
      - run:
          name: Analyze filtered vulnerabilities
          command: |
            echo "Analyzing filtered vulnerabilities..."
            python3 .circleci/pyscripts/analyze_trivy_report.py /tmp/filtered_vulnerabilities.json
            
            # Rename output files to include job name
            SCAN_JOB_NAME="${CIRCLE_JOB%-analyze}"
            SANITIZED_SCAN_JOB_NAME=$(echo "${SCAN_JOB_NAME}" | tr / -)
            mv filtered_vulnerabilities.txt "${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.txt"
            mv filtered_vulnerabilities.csv "${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.csv"
      - store_artifacts:
          path: "*_filtered_vulnerabilities.txt"
          destination: trivy-reports
      - store_artifacts:
          path: "*_filtered_vulnerabilities.csv"
          destination: trivy-reports
      - run:
          name: Create Jira Issues
          context: Jira-secrets
          command: |
            SCAN_JOB_NAME="${CIRCLE_JOB%-analyze}"
            SANITIZED_SCAN_JOB_NAME=$(echo "${SCAN_JOB_NAME}" | tr / -)
            
            if [[ ! -f "${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.txt" ]]; then
              echo "No ${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.txt found. Skipping Jira issue creation."
              exit 0
            fi
  
            echo "Creating Jira Issues from ${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.txt..."
            python3 .circleci/pyscripts/create_jira_issues.py "${SANITIZED_SCAN_JOB_NAME}_filtered_vulnerabilities.txt"
            