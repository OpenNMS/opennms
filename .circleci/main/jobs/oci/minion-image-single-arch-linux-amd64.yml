jobs:
  minion-image-single-arch-linux-amd64:
    machine:
      image: ubuntu-2004:202010-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
      - attach_workspace:
          at: ~/
      - qemu-user-static
      - install-buildx
      - dockerhub-login
      - acr-login
      - run: *setup_dct_env
      - run: *setup_dct_key
      - run:
          name: Single-arch build & push
          command: |
            cd opennms-container/minion
            ARCH="$(printf "linux/amd64" | tr / -)"
            TAG="${DOCKER_IMAGE_VERSION}-${ARCH}"
            make DOCKER_ARCH="linux/amd64" \
                 DOCKER_IMAGE_NAME="minion-${TAG}.oci" \
                 VERSION="${TAG}" \
                 BUILD_NUMBER="${CIRCLE_BUILD_NUM}" \
                 BUILD_URL="${CIRCLE_BUILD_URL}" \
                 BUILD_BRANCH="${CIRCLE_BRANCH}" \
                 build install
            docker push ${MINION_DK_REPO}:${TAG}
            echo "pushed to DK"
            docker tag ${MINION_DK_REPO}:${TAG} ${MINION_AZ_REPO}:${TAG}
            export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE=${AZURE_DCT_CI_PASSPHRASE}
            docker trust key load $KEY_FOLDER/$AZURE_DCT_CI_KEY_ID.key
            docker push ${MINION_AZ_REPO}:${TAG}
            echo "pushed to AZ"
            cd ~/project/
            if [ ! -d target/config-schema ]
            then
              mkdir target/config-schema
            fi
            cp opennms-container/minion/minion-config-schema.yml "target/config-schema/"
      - cache-workflow-assets:
          cache_prefix: minion-config-schema
          source_path: target/config-schema/
      - store_artifacts:
          when: always
          path: ~/project/target/config-schema
      - cache-oci:
          key: minion-linux/amd64
          path: opennms-container/minion/images/
      - store_artifacts:
          path: ~/project/opennms-container/minion/images/
          destination: /
