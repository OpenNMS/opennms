jobs:
  minion-image-single-arch:
    parameters:
      architecture:
        type: string
    machine:
      image: ubuntu-2004:202010-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
      - attach_workspace:
          at: ~/
      - qemu-user-static
      - install-buildx
      - dockerhub-login
      - acr-login
      - run: *setup_dct_env
      - run: *setup_dct_key
      - run:
          name: Single-arch build & push
          command: |
            cd opennms-container/minion
            ARCH="$(printf "<< parameters.architecture >>" | tr / -)"
            TAG="${DOCKER_IMAGE_VERSION}-${ARCH}"
            make DOCKER_ARCH="<< parameters.architecture >>" \
                 DOCKER_IMAGE_NAME="minion-${TAG}.oci" \
                 VERSION="${TAG}" \
                 BUILD_NUMBER="${CIRCLE_BUILD_NUM}" \
                 BUILD_URL="${CIRCLE_BUILD_URL}" \
                 BUILD_BRANCH="${CIRCLE_BRANCH}" \
                 build install
            docker push ${MINION_DK_REPO}:${TAG}
            echo "pushed to DK"
            docker tag ${MINION_DK_REPO}:${TAG} ${MINION_AZ_REPO}:${TAG}
            export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE=${AZURE_DCT_CI_PASSPHRASE}
            docker trust key load $KEY_FOLDER/$AZURE_DCT_CI_KEY_ID.key
            docker push ${MINION_AZ_REPO}:${TAG}
            echo "pushed to AZ"
      - cache-oci:
          key: minion-<< parameters.architecture >>
          path: opennms-container/minion/images/
      - store_artifacts:
          path: ~/project/opennms-container/minion/images/
          destination: /
