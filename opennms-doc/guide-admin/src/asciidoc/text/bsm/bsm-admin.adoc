
// Allow GitHub image rendering
:imagesdir: ../../../images

This section describes how to model and configure _Business Services (BS)_.

_Business Service Monitoring (BSM)_ includes the following components:

* _Business Service Monitoring Daemon (BSMD)_: Maintains and drives the state of all _BS_
* _Business Service Editor_: Web application which allows you to create, update or delete _BS_
* _Topology View for Business Services_: Visual representation of the _Business Service Hierarchy_ as a component of the _Topology User Interface_.
* _BSM ReST API_: ReST based API to create, read, update or delete _BS_

The following sections describe how these components are used in further detail:

=== Business Service Definition


_Business Services_ are used to represent services provided by the business e.g. a web portal for placing orders or wireless network access in a hotel.
_BS_ are defined with a set of dependencies called _Edges_ and _Map/Reduce_ functions which define how the _Operational Status_ of the _BS_ is derived from it's _Edges_.
_BS_ ultimately rely on a set of _Reduction Keys_ which are used to reference specific instances of an _Alarm_, e.g. a specific monitored service, threshold or SNMP trap.

A _BS_ is defined with the following components:

* _Business Service Name_: A unique name used to identify the _BS_
* _Edges_: A set of elements on which this _BS_ relies which can include other _BS_, or _Reduction Keys_.
* _Reduce Function_: Function used to aggregate the _Mapped_ status of all the edges, into a single status. Specific functions may take additional parameters.
* _Attributes_: Optional key/value pairs that can be used to tag or identify the service.

==== Reduce Functions

A _Reduce Function_ is used to aggregate the _Operational Status_ for the _BS_.
The _Alarm Severity_ from the _Edges_ are used as input for the _Reduce Function_.
For this operation the following _Reduce Functions_ are available:

.Status calculation _Reduce Functions_
[options="header, autowidth"]
|===
| Name                      | Description
| `Highest Severity`        | Uses the value of the highest severity, _Weight_ is ignored.
| `Threshold`               | Uses the highest severity found more often than the given threshold, e.g. 0.26 can also be seen as 26%, which means at least 2 of 4 _Alarms_ need to be raised to change the _BS_.
| `Highest Severity Above`  | Uses the highest severity greater than the given threshold severity.
|===

The following table shows the status calculation with _Edges_ assigned to an _IP Service_.
The _IP-Service_ is driven by the monitoring of the _ICMP_ service for three Web Server.
In the table below you find a configuration where _Web Server 3_ is weighted 3 times higher than the other and a threshold of 0.33 (33%) is configured.

.Example for status calculation using the Threshold function
[options="header, autowidth"]
|===
| Name       | Weight | Weight Factor | Input Severity | Operational Status | Critical | Major | Minor | Warning | Normal
| Web-ICMP-1 |   1    |     0.2       |    Critical    |      Critical      |    0.2   |  0.2  |  0.2  |   0.2   |  0.2
| Web-ICMP-2 |   1    |     0.2       |     Normal     |       Normal       |    0     |  0    |  0    |   0     |  0.2
| Web-ICMP-3 |   3    |     0.6       |    Warning     |      Warning       |    0     |  0    |  0    |   0.6   |  0.6
| Total      |        |     1.0       |                |                    |    0.2   |  0.2  |  0.2  |   0.8   |  1
| Percentage |        |     100%      |                |                    |    20%   |  20%  |  20%  |   80%   |  100%
|===

The _Operational Status Severity_ is evaluated from left to right, the first value higher then the configured _Threshold_ is used.
In this case the _Operational Status_ is set to _Warning_ because the first threshold which exceeds _33%_ is _Warning_ with _80%_.

==== Edges

The following types can be used:

* _Child Service_: A reference to an existing _Business Service_ on which to depend
* _IP Service_: A convenient way to refer to the alarms that can be generated by a monitored _IP Service_. This will automatically provided edges for the _nodeLostService_, _interfaceDown_ and _nodeDown_ reductions keys of the specified service.
* _Reduction Key_: A resolved _Reduction Key_ used to refer to a specific _Alarm_, e.g. generated by a _SNMP Trap_ or _Threshold_ violation

TIP: If you need help determining the reduction key used by alarm, trigger the alarm in question and pull the reduction key from the _Alarm_ details page.

All edge types have the following parameters:

* _Map Function_: The associated _Map Function_ for this _Edge_
* _Weight_: The relative _Weight_ of this edge. Used by certain _Reduce Functions_.

Both _IP Service_ and _Reduction Key_ type edges also support a _Friendly Name_ parameter which gives the user control on how the edge is labeled in the _Topology User Interface_.

===== Edge with Child Services

The _Child Service_ represents an existing _BS_ and is used to model a _BS_ dependency.

IMPORTANT: The _BS Dependency Graph_ is a directed acyclic graph.
           This mean that a _BS_ can be only selected once as dependency in a given _BS Hierarchy_.

===== Edge with IP Services

The _IP Service_ is a predefined set of _Reduction Keys_ which allows easily to assign a specific _Monitored Service_ to the given _BS_.
As an example you have multiple Servers with a _Monitored Service_ _SMTP_ and you want to model a _BS_ named _Mail Communication_.
If just the _Reduction Key_ for a _nodeLostService_ is assgined, the _BS_ would not be affected in case the _IP Interface_ or the whole _Node_ goes down.
_OpenNMS_ generates _Alarms_ with different _UEI_ which needs to be assigned to the _BS_ as well.
To make it easier to model this use case the _IP Service_ generates the following _Reduction Keys_ automatically:

* `uei.opennms.org/nodes/nodeLostService:%nodeId%:%ipAddress%:%serviceName%`: Matches _Alarms_ when the given _Monitored Service_ goes down
* `uei.opennms.org/nodes/interfaceDown:%nodeId%:%ipAddress%`: Matches _Alarms_ when the given _IP Interface_ of the _Monitored Service_ goes down
* `uei.opennms.org/nodes/nodeDown:%nodeId%`: Matches _Alarms_ when the given _Node_ of the _Monitored Service_ goes down

===== Edges with Reduction Keys

The _Reduction Key_ edge is used to refer to specific instance of alarms.
When an alarm with the given _Reduction Key_ is present, the alarms' severity will be used to calculate the _Operational Status_ of the _BS_.

===== Map Functions

The _Map Functions_ define how the _Severity_ of the edge will be used in the _Reduce Function_ of the parent when calculating the _Operational Status_.

The available _Map Functions_ are:

.Calculation of the _Operational Status_ with _Map Functions_
[options="header, autowidth"]
|===
| Name       | Description
| `Identity` | Use the same _Severity_ as _Operational Status_ of the _BS_
| `Increase` | Increase the _Severity_ by one level and use it as _Operational Status_ of the _BS_
| `Decrease` | Decrease the _Severity_ by one level and use it as _Operational Status_ of the _BS_
| `SetTo`    | Set the _Operational Status_ to a constant _Severity_ value
| `Ignore`   | The input of the _Edge_ is ignored for _Operational Status_ calcualation
|===

==== Attributes

Each _Business Service_ can contain a list of optional key/value attributes.
These can be used to identify or tag the _BS_, and may be reference in other workflows.
These attributes do not affect the dependencies or the status calculation of the _BS_.

TIP: Attributes can be used to filter _BS_ in _Ops Board_ dashlets.

=== Business Service Daemon

The calculation of the _Operational Status_ of the _BS_ is driven by the _Business Service Monitoring Daemon_ (bsmd).
The daemon is responsible for tracking the operational status of all _BS_ and for sending events in case of operational status changes.
Every time the configuration of a _Business Service_ is changed a reload of the daemon's configuration is required.
This includes changes like the name of the _Business Service_ or its attributes as well as changes regarding the _Reduction Keys_, contained _Business Services_ or _IP Services_.
The _bsmd_ configuration can be reloaded with the following mechanisms:

* Click the _Reload Daemon_ button in the _Business Service Editor_
* Send the _reloadDaemonConfig_ event using `send-event.pl` or use the WebUI in _Manually Send an Event_ with parameter `daemonName bsmd`
* Use the ReST API to perform a `POST` request to `/opennms/api/v2/business-services/daemon/reload`

If the reload of the configuration is done an event of type `uei.opennms.org/internal/reloadDaemonConfigSuccessful` is fired.

.Example reloading bsmd configuration from CLI
[source,shell]
----
$OPENNMS_HOME/bin/send-event.pl -p 'daemonName bsmd' uei.opennms.org/internal/reloadDaemonConfig
----

.Example reloading bsmd configuration through ReST POST
[source,shell]
----
curl -X POST -u admin:admin -v http://localhost:8980/opennms/api/v2/business-services/daemon/reload
----
