
// Allow GitHub image rendering
:imagesdir: ../images

Events are central to the operation of the {opennms-product-name} platform, so it's critical to have a firm grasp of this topic.

IMPORTANT: Whenever something in {opennms-product-name} appears to work by magic, it's probably events working behind the curtain.

[[section-events-anatomy-of-an-event]]
=== Anatomy of an Event

Events are structured historical records of things that happen in {opennms-product-name} and the nodes, interfaces, and services it manages.
Every event has a number of fixed *fields* and zero or more *parameters*.

.Mandatory Fields
UEI (Universal Event Identifier)::
    A string uniquely identifying the event's type.
    UEIs are typically formatted in the style of a URI, but the only requirement is that they start with the string `uei.`.
Event Label::
    A short, static label summarizing the gist of all instances of this event.
Description::
    A long-form description describing all instances of this event.
Log Message::
    A long-form log message describing this event, optionally including expansions of fields and parameters so that the value is tailored to the event at hand.
Severity::
    A severity for this event type.
    Possible values range from `Cleared` to `Critical`.
Event ID::
    A numeric identifier used to look up a specific event in the {opennms-product-name} system.

.Notable Optional Fields
Operator Instruction::
    A set of instructions for an operator to respond appropriately to an event of this type.
Alarm Data::
    If this field is provided for an event, {opennms-product-name} will create, update, or clear *alarms* for events of that type according to the alarm-data specifics.
    For more about alarms and how they relate to events, see <<alarms-introduction>>.

[[section-events-sources-of-events]]
=== Sources of Events

Events may originate within {opennms-product-name} itself or from outside.

Internally-generated events can be the result of the platform's monitoring and management functions (_e.g._ a monitored node becoming totally unavailable results in an event with the UEI `uei.opennms.org/nodes/nodeDown`) or they may act as inputs or outputs of housekeeping processes.

The following subsections summarize the mechanisms by which externally-created events can arrive.

==== SNMP Traps

If SNMP-capable devices in the network are configured to send *traps* to {opennms-product-name}, these traps are transformed into events according to pre-configured rules. The `Trapd` service daemon, which enables {opennms-product-name} to receive SNMP traps, is enabled by default.

IMPORTANT: Disabling the `Trapd` service daemon will render {opennms-product-name} *incapable* of receiving SNMP traps.

Event definitions are included with {opennms-product-name} for traps from many vendors' equipment.

==== Syslog Messages

Syslog messages sent over the network to {opennms-product-name} can be transformed into events according to pre-configured rules.

IMPORTANT: The `Syslogd` service daemon, which enables {opennms-product-name} to receive syslog messages over the network, must be enabled for this functionality to work. This service daemon is *disabled* by default.
    
==== TL1 Autonomous Messages

Autonomous messages can be retrieved from certain TL1-enabled equipment and transformed into events.

IMPORTANT: The `Tl1d` service daemon, which enables {opennms-product-name} to receive TL1 autonomous messages, must be enabled for this functionality to work. This service daemon is *disabled* by default.

==== XML-TCP
Any application or script can create custom events in {opennms-product-name} by sending properly-formatted XML data over a TCP socket.

==== ReST

Posting an event in XML format to the appropriate endpoint in the {opennms-product-name} ReST API will cause the creation of a corresponding event, just as with the XML-TCP interface.

[[section-events-event-bus]]
=== The Event Bus

At the heart of {opennms-product-name} lies an *event bus*.
Any {opennms-product-name} component can _publish_ events to the bus, and any component can _subscribe_ to receive events of interest that have been published on the bus.
This publish-subscribe model enables components to use events as a mechanism to send messages to each other.
For example, the provisioning subsystem of {opennms-product-name} publishes a _node-added_ event whenever a new node is added to the system.
Other subsystems with an interest in new nodes subscribe to the _node-added_ event and automatically receive these events, so they know to start monitoring and managing the new node if their configuration dictates.
The publisher and subscriber components do not need to have any knowledge of each other, allowing for a clean division of labor and lessening the programming burden to add entirely new {opennms-product-name} subsystems or modify the behavior of existing ones.

[[section-events-events-in-action]]
==== Events in Action

[[section-events-events-in-action-notifications]]


[[section-events-forwarding-to-elastisearch]]
==== Forwarding Events to Elasticsearch

OpenNMS can be configured to forward all events and alarms to https://www.elastic.co/products/elasticsearch[Elasticsearch] for indexing, long time archiving, plotting with Grafana
and browsing with Kibana.

NOTE: Elasticsearch is not intended as a replacement for Postgres which is still a required component to run OpenNMS.

First check that your OpenNMS installation supports this feature. If it does
there should be a '${OPENNMS_HOME}/etc/org.opennms.features.elasticsearch.eventforwarder.cfg' file.

If there is open it and review its content. Make sure to apply the correct settings depending
on your environment.

The following table describes all settings and possible values.

[options="header, autowidth"]
|===
| Parameter              | Default          |  Description 
|`elasticsearchCluster`  | opennms          | The name of the elasticsearch cluster as specified in the elasticsearch configuration file (required).
|`elasticsearchIp`       | localhost        | the TransportClient remote host ip to use. Has the same meaning as the ip options of the http://camel.apache.org/elasticsearch.html[camel-elasticsearch] component
|`logEventDescription`   | false            | Whether to forward the event description to Elasticsearch. Th reason it is off by default is that it is usually some standard and possibily long text which will grow the index without adding useful information
|`cache_max_ttl`         | 0                | The number of minutes the node information is kept in the cache. Set to 0 to disable (which is the default and is generally safe because the cache knows when to refresh itself, by intercepting nodeUpdated and similar events)
|`cache_max_size`        | 10000            | The number of node information entries to be kept in the cache before eviction start. Set to 0 to disable.
|===

Once you are sure everything is correctly configured you can activate the Elasticsearch forwarder.

Log into the OSGi console (ssh admin@localhost -p 8101) and install the feature with the following command:

`features:install opennms-elasticsearch-event-forwarder`

You can check the routes status with the camel:* commands and/or inspect the log with log:tail for any obvious errors. The feature has a trace level logging that can be used to trace operations.

If all goes well events and alarms will be pushed in realtime into Elasticsearch.
You should now be able to view the events and graph them with https://www.elastic.co/products/kibana[Kibana].

If you have never used Kibana before you should probably start with Kibana 3 which is simpler.
Kibana 4 is more powerful, but harder to get started with.

*Troubleshooting*

If events are not reaching Elasticsearch check that OpenNMS is correctly
configured, in particulare review the `elasticsearchCluster` and `elasticsearchIp`.

If those appear to be correct verify that OpenNMS can communicate with
Elasticsearch over port 9300.
