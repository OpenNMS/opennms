
// Allow GitHub image rendering
:imagesdir: ../../../images

[[ga-alarmd-configuration]]
=== Configuring Alarms

Since Alarmd instantiates Alarms from Events, defining Alarms in _{opennms-product-name}_ entails defining an additional XML element of an Event indicating a problem or resolution in the Network.
This additional element is the "alarm-data" element.

NOTE: Any Event that is marked as "donotpersist" in the logmsg element's "dest" attribute, will not be processed as an Alarm.

.alarm-data Schema Definition (XSD)
[source,XML]
----
<element name="alarm-data">
  <annotation>
    <documentation>This element is used for converting events into alarms.</documentation>
  </annotation>
  <complexType>
    <sequence>
      <element ref="this:update-field" minOccurs="0" maxOccurs="unbounded" />
    </sequence>
    <attribute name="reduction-key" type="string" use="required" />
    <attribute name="alarm-type" use="required" >
      <simpleType>
        <restriction base="int">
          <minInclusive value="1"/>
        </restriction>
      </simpleType>
    </attribute>
    <attribute name="clear-key" type="string" use="optional" />
    <attribute name="auto-clean" type="boolean" use="optional" default="false" />
    <attribute name="x733-alarm-type" type="this:x733-alarm-type" use="optional" />
    <attribute name="x733-probable-cause" type="int" use="optional" />
  </complexType>
</element>

<element name="update-field">
  <complexType>
    <attribute name="field-name" type="string" use="required" />
    <attribute name="update-on-reduction" type="boolean" use="optional" default="true" />
    <attribute name="value-expression" type="string" use="optional" default="" />
  </complexType>
</element>

<simpleType name="x733-alarm-type">
  <restriction base="string" >
    <pattern value="CommunicationsAlarm|ProcessingErrorAlarm|EnvironmentalAlarm|QualityOfServiceAlarm|EquipmentAlarm|IntegrityViolation|SecurityViolation|TimeDomainViolation|OperationalViolation|PhysicalViolation" />
  </restriction>
</simpleType>
----
*NOTE*
See also: <<ga-events-anatomy-of-an-event>>

.The reduction-key
The critical attribute when defining the alarm-data of an Event, is the _reduction-key_.
This attribute can contain literal strings as well as references to properties (fields and parameters) of the Event.
The purpose of the reduction-key is to uniquely identify the signature of a problem and, as such, is used to reduce (de-duplicate) Events so that only one problem is instantiated.
Most commonly, the event's identifier (UEI) is used as the left most (least significant) portion of the reduction-key, followed by other properties of the Event from least to most significant and, traditionally, separated with the literal ':'.

.Multi-part reduction-key
====
[source,XML]
----
<event>
   <uei>uei.opennms.org/nodes/nodeDown</uei>
...
   <alarm-data reduction-key="%uei%:%dpname%:%nodeid%" alarm-type="1" auto-clean="false"/>
</event>
----
====

.Least Significant reduction-key Attribute
====
TIP: Decreasing the significance of the reduction-key is a way to aggregate, for example, all nodes down in to a single alarm.
However, there are caveats:

[source,XML]
----
<event>
  <uei>uei.opennms.org/nodes/nodeDown</uei>
  <alarm-data reduction-key="%uei%" alarm-type="1"/>
</event>
----
With this reduction-key, a single alarm would be instantiated for all nodes that were determined by the Poller to be down.
There would be a single alarm with the count representing the number of nodes down.
However, the UEI +uei.opennms.org/nodes/nodeUp+ would *not* be a good ''pair wise'' reduction-key for resolving this alarm as it would take only a single ''node up'' to clear all nodes down tracked with this single alarm configuration.
====

.The alarm-type attribute
The second most critical attribute is the alarm-type.
There are currently three types of alarms: problem (1), resolution (2), and notification (3).
The alarm-type attribute helps Alarmd with pair-wise resolution... the matching of resolution events to problem events.

.The clear-key attribute
This attribute is now deprecated with the release of H23.
It was previously used in the pair-wise Event correlation feature of Alarmd.

.The auto-clean attribute
This attribute instructs Alarmd to only retain the most recent Event reduced into an alarm.
For alarms that are super chatty, this is a way to reduce the size of the most recent Events in the database.

WARNING: Do not use this feature with Alarms that have pair-wise correlation (matching problems with resolutions).

.The update-field element
Use this element to override Alarmd's default behavior for which some fields are updated during reduction.
The Alarm fields that are currently allowed to be controlled this way are:
.Bulleted
* distpoller
* ipaddr
* mouseover
* operinstruct
* severity
* descr
* acktime
* ackuser

NOTE: With the new single alarm behavior in H23, if an Alarm transitions from an alarm-type 2 back to alarm-type 1 the Severity will be set to the most Event's value.

.Reduction (de-duplication) of Alarms
Alarmd is designed to reduce multiple occurrences of an Alarm into a single alarm.

.Pairwise Correlation
Alarmd is also intrinsically designed to automatically match resolving events with an existing Alarm.
