
// Allow GitHub image rendering
:imagesdir: ../../images

=== Overview

_{opennms-product-name}_ has introduced the ability for users to define arbitrarily complex
 layered topologies using GraphML (see http://graphml.graphdrawing.org/). 
 The details of how _{opennms-product-name}_ interprets GraphML are given in the 
 GraphML section of the _{opennms-product-name}_ developers guide. The ability to display 
 complex layered topologies is a great feature but creating a usable GraphML topology for a 
 large network can be a complex task for a user. 

The _Asset Topology Provider_ avoids the need for users to work directly with GraphML 
by directly generating a layered GraphML topology based upon node parameters and the contents of the Node Asset table.
 The _Asset Topology Provider_ greatly simplifies the task for many use cases by allowing users 
 to define fields in the Node Asset table which will enable nodes to be positioned correctly
  in a complex topology. This allows a physical and logical ordering of nodes which makes 
  it easier for users to represent and navigate their infrastructure.

The structure of the generated topology is determined by the `assetLayers` configuration 
constant which can be set by a user. To illustrate how this works, we will consider the following configuration:
----
assetLayers=asset-region,asset-building
----
The _{opennms-product-name}_ Asset table is parsed to generate nested layers in 
the order of the comma separated keys in the assetLayers property. 
Each layer is a graph which is named after the key. Graph nodes in each layer reference 
related Graph nodes in the underlying layer. The lowest layer contains Graph nodes which 
are directly linked to monitored _{opennms-product-name}_ nodes which have entries in the Asset table.

The following diagram shows the structure of a topology generated by the above `assetLayers` property

image:asset-topology/graphMLtopologyLayers.jpg[Illustrating how node asset entries are interpreted as layers]

In this example the `region` asset fields for node 1,2,3,4 are set to north. 
All of these nodes are in the same north region. The `building` asset fields 
for Node 1 and Node 2 are set to 21 (both nodes are in building 21) while the 
`building` asset fields for Node 3 and Node 4 are set to 22 (both nodes are in building 22). 

The _Asset Topology Provider_ generates four linked graphs for this configuration. 
The layer 0 graph is called `asset-region`, the layer 1 graph is called `asset-building` 
and the layer 2 graph is called `nodes`. 

Conceptually we can see that the topology is rendered as concentric sets. 
The _Asset Topology Provider_ first searches all of the nodes with regions 
defined and creates a new level 0 graph node representing each region found. 
The _Asset Topology Provider_ then searches within each region to find the building entries and 
creates a corresponding level 1 graph node for each building name found. Finally the _Asset Topology Provider_ 
creates layer 2 nodes corresponding to each _{opennms-product-name}_ monitored node and places each in the correct building. 

If however _{opennms-product-name}_ monitored nodes are found which have either the region 
or building asset fields empty they cannot be placed correctly in this topology. 
These nodes as shown in the diagram as `unallocated nodes`. 
Finally, only building and region nodes are generated which can be linked to _{opennms-product-name}_ nodes in the topology. 
The _Asset Topology Provider_ does not generate spurious graph nodes in upper 
layers which are not directly and completely referenced by _{opennms-product-name}_ nodes in the lowest layer.

Example screenshots of a topology containing regions, buildings, racks and nodes are shown below

image::asset-topology/AssetScreen1.png[Screenshot of Regions Layer,400,600]

image::asset-topology/AssetScreen2.png[Screenshot of Buildings Layer,400,600]

image::asset-topology/AssetScreen3.png[Screenshot of Nodes Layer,400,600]

=== Asset layers
The entries for `assetLayers` can be any node or asset entry from the following list (defined in class NodeParamLabels). 
Keys beginning with `node-` come from the node table.
Keys beginning with `parent-` come from the node table entry of the designated parent node (If defined).
Keys beginning with `asset-`  come from the corresponding asset table entry for the given node (If defined).

[options="autowidth"]
|===
| node-nodelabel | node-nodeid | node-foreignsource | node-foreignid | node-nodesysname 
| node-nodesyslocation | node-operatingsystem | node-categories| | 
| parent-nodelabel | parent-nodeid | parent-foreignsource | parent-foreignid | 
| asset-address1 | asset-address2| asset-city | asset-zip| asset-state
| asset-latitude | asset-longitude| asset-region | asset-division| asset-department
| asset-building | asset-floor| asset-room | asset-rack | asset-slot
| asset-port | asset-circuitid | asset-category | asset-displaycategory | asset-notifycategory
| asset-pollercategory | asset-thresholdcategory | asset-managedobjecttype | asset-managedobjectinstance | asset-manufacturer
| asset-vendor | asset-modelnumber | asset-description | asset-operatingsystem | asset-country
|===

This allows arbitrary topologies to be generated including physical fields (room, rack etc.) and 
logical fields such as asset node categories. Please note you should not put any spaces in the comma separated `assetLayers` list. 
If the `assetLayers` property is defined as empty then a single graph layer will be generated containing all opennms nodes.

=== Node filtering
In many cases it is desirable to control which nodes are included or excluded from a topology. For instance it is
useful to be able to generate customised topologies for specific customers which include only regions/buildings etc 
relevant to their filtered node set. To this end it is possible to define a node filter 
which chooses which nodes are included in a generated topology.

Filters are defined using the same asset table keys which are available for the `assetLayers` field. 

[options="header, autowidth"]
|===
| Operation  | Definition  | Example
| OR | key1=value1,value2 alternatively key1=value1;key1=value2 | asset-region=north,south
| AND | key1=val1;key2=val2 | asset-region=north;asset-building=23
| NOT | key1=!val1 | asset-building=!23
|===

Thus the following configuration means include only nodes with region `north` or `south` but exclude all nodes with building `23`.
----
filter=asset-region=north,south;asset-building=!23
----
The filters are designed to treat all selected text key entries as comma separated values (csv). This allows OpenNMS node-categories which are
many to many entries to be dealt with as a comma separated list of values; routers,servers,web etc. 
Thus we can select based on multiple separate node categories. The following configuration means show routers and servers on all buildings except building 23.
----
filter=node-categories=routers,servers;asset-building=!23
----
The filters treat all asset table entries as comma separated variables (csv). This also means that, 
for instance asset-displaycategory could also contain several values separated by commas. e.g. customer1,customer2,customer3 etc.

NOTE: You should make sure asset addresses and other free format asset text fields do not contain commas if you want an exact match on the whole field

Regular expressions are also allowed. Regular expressions start with the ~ character. 
You can also negate a regular expression by preceding it with !~.

The following example will match against regions 'Stuttgart' and 'Isengard' and any building name which ends in 4
----
filter=asset-region=~.*gar(t|d);asset-building=~.*4
----

=== Configuration
The _Asset Topology Provider_ persists both the asset topology graph definitions and the generated GraphML graphs.
The persisted definitions mean that is is possible to regenerate graphs if the asset table is changed without reentering the configuration.

The _Asset Topology Provider_ persists GraphML graphs along side any other GraphML graphs in the directory;
----
<opennms home>/etc/graphml
----
Please note that if you are using ReST or any other means to generate other GraphML graphs, you should ensure that 
the providerIds and labels are distinct from those used by the _Asset Topology Provider_

The asset graph definitions for the Asset Topology Provider are persisted to the following xml configuration file:
----
<opennms home>/etc/org.opennms.features.topology.plugins.topo.asset.xml
----
Normally you should not edit this file directly but use the karaf consol or events to define new graphs.

The config file will contain each of the graph definitions as properties in the form
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<configs>
    <config>
        <label>Asset Topology Provider</label>
        <breadcrumb-strategy>SHORTEST_PATH_TO_ROOT</breadcrumb-strategy>
        <provider-id>asset</provider-id>
        <preferred-layout>Grid Layout</preferred-layout>
        <filters>
            <filter>asset-region=South</filter>
        </filters>
        <layers>
            <layer>asset-region</layer>
            <layer>asset-building</layer>
            <layer>asset-rack</layer>
        </layers>
    </config>
</configs>
----
The individual definition parameters are described in the following table

[options="header, autowidth"]
|===
| Parameter                 | Description
|`providerId` | The unique name of the provider - used as handle to install and remove the topology
|`label` | The name which shows up on the topology menu (must be unique)
|`assetLayers`| List of asset layers (in order). See separate description.
|`filters` | List of filters to be applied. Filters determine which nodes are included in graph.  See separate description.
|`preferredLayout` |  Preferred layout of the nodes in generated graphs. 
|`breadcrumbStrategy` | Breadcrumb strategy used to display breadcrumbs above each graph
|===

=== Creating Asset Based Topologies From Karaf Consol

The _{opennms-product-name}_ Karaf Consol can be used to control topology generation. To login use admin password.
----
ssh admin@localhost -p 8101
----
The following commands are available

[options="header, autowidth"]
|===
| Command                      | Description               | Options
| asset-topology:create        | Creates Asset Topology.   | 
(The default settings are used if a particular setting is not included in the command)

-l, --label : Asset Topology label (shows in topology menu) (Default: asset)

-i, --providerId : Unique providerId of asset topology (Default: 'Asset Topology Provider')

-f, --filter : Optional node filter (Default: empty filter i.e. allow all nodes)

-a, --assetLayers : Comma separated list of asset layers (Default: asset-region,asset-building,asset-rack)

-p, --preferredLayout : Preferred Layout (Default: 'Grid Layout')

-b, --breadcrumbStrategy : Bread Crumb Strategy (Default: SHORTEST_PATH_TO_ROOT)

If you simply type asset-topology:create a default topology with providerId asset will be created.

| asset-topology:remove        | Removes Asset Topology.   | 
-i, --providerId : Unique providerId of asset topology (Default: asset)
| asset-topology:list        | Lists all Asset Topologies installed.   | 
all : display detailed view including --uriParams string
| asset-topology:regenerate        | Regenerates the graphs for the given Asset Topology definition.   | 
-i, --providerId : Unique providerId of asset topology to regenerate (Default: asset)
| asset-topology:regenerateall        | Best Effort regeneration of all asset topologies. 
(If one graph fails, the command will try to complete the rest of the definitions definition)   | 
|===


=== Creating Asset Based Topologies Using _{opennms-product-name}_ events

The _Asset Topology Provider_ listens for events which trigger the generation and installation or removal of topologies. 
The _Asset Topology Provider_ events are defined in the file
----
<opennms home>/etc/events/GraphMLAssetPluginEvents.xml
----
These events will use the default parameters if parameters are not supplied

To create a new topology from the current OpenNMS inventory use 
----
(for default topology)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/create localhost

(or with parameters)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/create localhost  -p 'providerId test' -p 'label test' -p 'assetLayers asset-country,asset-city,asset-building'-->

other example possible parameters are
-p 'filters asset-displaycategory=!testDisplayCategory'
-p 'preferredLayout Grid Layout'
-p 'breadcrumbStrategy SHORTEST_PATH_TO_ROOT'
----

To uninstall an asset topology use
----
(for default topology providerId)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/remove localhost

(or with specific providerId)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/remove localhost -p 'providerId test'
----

To regenerate an existing asset topology use
----
(for default topology providerId)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/regenerate localhost

(or with specific providerId)
sudo ./send-event.pl  uei.opennms.plugins/assettopology/regenerate localhost-p 'providerId test'
----

To regenerate all existing asset topologies use
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/regenerateall localhost
----

=== Viewing the topology
If all goes well, having installed the topology, upon refreshing your screen, 
you should see a new topology display option in the _{opennms-product-name}_  topology page. 
The displayed name of this topology is given by the label field

The label field need not be the same as the providerId which is used by the ReST api for the installation 
or removal of a topology. However the label field must be unique across all installed topologies. 

It is possible to have several topologies installed which have been generated using different configurations.
You simply need to ensure that the providerId and label field used for each installation command is different.

=== Additional notes

Please note you MUST first uninstall an _{opennms-product-name}_ graphml topology before installing a new one. 
You will also have to log out and log back into the UI in order to see the new topology file. 
If you uninstall a topology while viewing it, the UI will throw an error and 
you will also have to log out and back in to see the remaining topologies. 

