// Allow GitHub image rendering
:imagesdir: ../../images

=== Using Offheap storage for Sink Messages

If minion experiences connectivity issues with _Kafka_ or _ActiveMQ_ there is a chance that Traps and Syslog messages may be lost as the internal queue is limited by heap size.
Offheap option will extend the queues outside heap to facilitate more storage for the sink messages.

NOTE: For now, offheap still uses device RAM memory outside java heap, doesn't use any file storage.

==== Configuring offheap storage

Install offheap feature on minion:

[source, sh]
----
echo 'opennms-core-ipc-sink-offheap' >> "$MINION_HOME/etc/featuresBoot.d/features.boot"
----

Configure storage and enable offheap as below:

[source, sh]
----
echo 'offHeapSize=1.2GB
enableOffHeap=true' > "$MINION_HOME/etc/org.opennms.core.ipc.sink.offheap.cfg"
----

Specify offHeapSize in KB, MB or GB. For ex: 1.2GB, 2.5MB, 845KB. It will be converted to bytes.
In above example, offHeapSize is configured to 1.2GB. That is 1288490188 bytes.
For ex: 1.2MB is valid.  1gb is not valid.

When using Offheap storage option, it is best to reduce default queue size of sink module to match batch size. So all the buffering happens on offheap.

When using _Kafka_ as sink strategy, each sink message will expire after 30sec by default.
To queue it for extended period, kafka producer property `retries` can be updated.
For ex: for `retries` 100, each sink message will queue atleast for 30 mins before getting dropped.
