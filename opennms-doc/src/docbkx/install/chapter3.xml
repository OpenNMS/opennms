<?xml version="1.0" encoding="UTF-8"?>
<chapter>
  <title>Installing OpenNMS</title>

  <note>
    <para>You need to be root when you execute the commands in this
    chapter.</para>
  </note>

  <para>Follow the instructions in either the fresh install section or the
  upgrade section, and then continue to the section on running the installer.
  If you have any errors during the installation process, please see the
  troubleshooting section of this guide.</para>

  <section>
    <title>Installing jicmp</title>

    <para>Java has never had a really good API for ICMP. Since ICMP is the
    basis for the "ping" command, it is rather imperative that any Java-based
    network management platform address the need for ICMP. OpenNMS does this
    by using some code written in C, and accessing it using the Java Native
    Interface (JNI). </para>

    <para>With OpenNMS 1.3.6, this code has been moved to its own library
    outside of OpenNMS. This makes the main OpenNMS application pure Java, and
    as such it only has to be built once, instead of for each platform.</para>

    <para>However, now jicmp has to be installed. The goal is to provide
    packages for most distributions. For RPM-based distros, the source code
    tarball can be <ulink
    url="http://sourceforge.net/project/showfiles.php?group_id=4141&amp;package_id=240236">fetched
    from Sourceforge</ulink>, and the command</para>

    <para><programlisting>rpmbuild -tb [source tarball filename]</programlisting></para>

    <para>executed to create an RPM. Otherwise the source tarball can be
    extracted and the usual "configure; make; make install" run to compile and
    install it. It should be installed before continuing.</para>
  </section>

  <section>
    <title>Performing a Fresh Install</title>

    <para>Follow the instructions in this section appropriate for your
    operating system if you are performing a fresh install. If you are
    upgrading an existing installation of OpenNMS, see the next
    section.</para>

    <section>
      <title>Installing on RPM-based Linux Distributions</title>

      <para>Download the appropriate packages for your Linux distribution from
      the OpenNMS <ulink
      url="http://sourceforge.net/project/showfiles.php?group_id=4141">Files</ulink>
      section on SourceForge.</para>

      <para><programlisting><computeroutput># </computeroutput><command>rpm -i opennms-@product.version@-@product.release@_&lt;distribution&gt;.&lt;platform&gt;.rpm
</command><computeroutput># </computeroutput><command>rpm -i opennms-webapp-@product.version@-@product.release@_&lt;distribution&gt;.&lt;platform&gt;.rpm
</command><computeroutput># </computeroutput><command>rpm -i opennms-docs-@product.version@-@product.release@_&lt;distribution&gt;.&lt;platform&gt;.rpm</command></programlisting></para>
    </section>

    <section>
      <title>Installing on Solaris</title>

      <para>Download the appropriate package for your Solaris version from the
      OpenNMS <ulink
      url="http://sourceforge.net/project/showfiles.php?group_id=4141">Files</ulink>
      section on SourceForge.</para>

      <para><programlisting><computeroutput># </computeroutput><command>cd /usr/local
</command><computeroutput># </computeroutput><command>gzip -d opennms-@product.version@-@product.release@-sol&lt;version&gt;-sparc-local.gz
</command><computeroutput># </computeroutput><command>pkgadd -d `pwd`/opennms-@product.version@-@product.release@-sol&lt;version&gt;-sparc-local</command></programlisting></para>
    </section>

    <section>
      <title>Installing on Mac OS X</title>

      <para>OpenNMS is supported on Mac OS X via the <ulink
      url="http://fink.sourceforge.net/">fink</ulink> project.</para>
    </section>
  </section>

  <section>
    <title>Upgrading an Existing Installation</title>

    <para>Upgrades from a previous version of OpenNMS to a current one usually
    just involve installing a new package for your particular
    distribution.</para>

    <para>For RPM-based distributions, this is pretty simple using the
    "<computeroutput>rpm -Uvh [package name]</computeroutput>" command.</para>

    <para>In addition, the OpenNMS installer may attempt to make changes to
    the database. Follow the instructions later in this chapter for executing
    the installer. The changes should go smoothly, but as with the best laid
    plans things may go wrong. Make a backup of your PostgreSQL database per
    the details below before upgrading in case there are problems.</para>

    <para>To upgrade from 1.2.x to 1.3.x check out the <ulink
    url="http://www.opennms.org/index.php/Upgrading_from_1.2.x_to_1.3.x">wiki
    page</ulink>.</para>

    <section>
      <title>Basic Locations for OpenNMS Data</title>

      <para>OpenNMS stores data in a number of locations:</para>

      <glosslist>
        <glossentry>
          <glossterm><filename>$OPENNMS_HOME/etc/</filename></glossterm>

          <glossdef>
            <para>OpenNMS configuration files. If the default structure of a
            file in <filename>$OPENNMS_HOME/etc</filename> has changed between
            versions, RPM will create a
            "<filename><filename>.rpmnew</filename></filename>" version of
            that file. You will need to look at the changes between your file
            and the new one and merge them manually, at the moment. The
            command "<code>diff -u &lt;old file&gt; &lt;new file&gt; |
            less</code>" can assist you in seeing what has changed.</para>
          </glossdef>
        </glossentry>

        <glossentry>
          <glossterm><filename>$OPENNMS_HOME/share/rrd/</filename></glossterm>

          <glossdef>
            <para>RRD data files that store response time data and performance
            data collected from SNMP. The installer should not touch the RRD
            files in <filename>$OPENNMS_HOME/share/rrd.</filename> Unless you
            are moving from RRDTool to jRobin, you should not have to worry
            about them.</para>
          </glossdef>
        </glossentry>

        <glossentry>
          <glossterm><filename>$OPENNMS_HOME/webapps/opennms/</filename></glossterm>

          <glossdef>
            <para>The OpenNMS web application. While data is not stored here,
            some users may customize the web interface and these
            customizations should be saved before upgrading OpenNMS.</para>
          </glossdef>
        </glossentry>

        <glossentry>
          <glossterm><filename>$PGDATA/</filename></glossterm>

          <glossdef>
            <para>Data about nodes, services, events, notifications, etc., are
            stored in the <code>opennms</code> table in PostgreSQL.</para>
          </glossdef>
        </glossentry>
      </glosslist>
    </section>

    <section>
      <title>Before Upgrading - Make a Backup!</title>

      <para>Things can go wrong on upgrades, so it is always a good idea to
      make a backup of important information before attempting the
      upgrade.</para>

      <para>For OpenNMS, you should do a few things:</para>

      <orderedlist>
        <listitem>
          <para>Copy the contents of the
          <filename>$OPENNMS_HOME/etc</filename> directory to a safe location.
          Should an issue arise with any new files, you will want to be able
          to recover your original.</para>
        </listitem>

        <listitem>
          <para>Make a backup of the postgres database. Using the
          <filename>pg_dumpall</filename> command you can dump the entire
          contents of the database to a file:</para>

          <para><programlisting><computeroutput># </computeroutput><command>pg_dumpall &gt; old_data</command></programlisting></para>

          <para>will copy all of the data to a file called
          <filename>old_data</filename>. You will want to run this as the
          "postgres" user:</para>

          <para><programlisting><computeroutput># </computeroutput><command>sudo -u postgres pg_dumpall &gt; old_data</command></programlisting></para>

          <para>To restore, run the command:</para>

          <para><programlisting><computeroutput># </computeroutput><command>sudo -u postgres psql -U postgres -f old_data template1</command></programlisting></para>
        </listitem>

        <listitem>
          <para>If you have made changes to the web application, you will want
          to save a copy of your changes, as well.</para>
        </listitem>
      </orderedlist>

      <para>As mentioned earlier, there should be no need to backup the RRD
      files during an upgrade.</para>
    </section>
  </section>

  <section>
    <title>Run the Installer</title>

    <para>No matter which installation method above you choose, and whether
    you are performing a fresh install or an upgrade, you still need to run
    the installer. This tool will setup the <code>opennms</code> database
    within PostgreSQL and also install the OpenNMS web application ("webapp"
    or the "webUI") into Tomcat.</para>

    <section>
      <title>Configure Java for OpenNMS</title>

      <para>Before you execute the installer, OpenNMS needs to be configured
      to use an appropriate Java Runtime Environment (JRE). The OpenNMS tool
      <filename>runjava</filename> is used to set this up, and it can either
      search for a suitable JRE or you can tell it exactly which JRE to
      use.</para>

      <section>
        <title>Search for a JRE (suggested)</title>

        <para>Execute <filename>runjava</filename> with the "<code>-s</code>"
        option to search for a JRE:</para>

        <programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/runjava -s</command></programlisting>
      </section>

      <section>
        <title>Configure a specific JRE</title>

        <para>Execute runjava with the "-S &lt;path to JRE&gt;" option to
        specify the exact JRE you want OpenNMS to use:</para>

        <programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/runjava -S &lt;path to JRE&gt;</command></programlisting>

        <para>Note that you will need the path to the "java" executable - i.e.
        the file named "java" - usually in $JAVA_HOME/bin.</para>
      </section>
    </section>

    <section>
      <title>Run the Installer to Setup the PostgreSQL Database and
      jicmp/jrrd</title>

      <programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/install -l /usr/local/lib -dis</command></programlisting>

      <para>The "-l" parameter will look for the jicmp and/or jrrd libraries
      in the location specified. The "-dis" will initialize and check the
      database. Note at the end of the output from the installer it will
      indicate if iplike has been installed properly.</para>
    </section>

    <section>
      <title>Run the Installer to Setup the Web Application</title>

      <programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/install -y -w $CATALINA_HOME/conf/Catalina/localhost</command></programlisting>

      <para>$CATALINA_HOME is the base directory of your Tomcat
      installation.</para>
    </section>
  </section>
</chapter>