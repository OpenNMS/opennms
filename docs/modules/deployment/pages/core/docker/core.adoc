:docker-version-tag: bleeding
ifeval::["{prerelease}" == "false"]
:docker-version-tag: {full-display-version}
endif::[]

.Create a project directory for {page-component-title} Core and create a `docker-compose.yml` file.
[source, console]
----
cd core
vi docker-compose.yml
----

[source, docker-compose.yml]
[subs="verbatim,attributes"]
----
---
volumes:<1>
  data-postgres: {}
  data-opennms: {}
  data-config: {}

services:
  database:<2>
    image: postgres:{postgresql-version}
    environment:
      TZ: UTC<3>
      POSTGRES_USER: postgres<4>
      POSTGRES_PASSWORD: "my-postgres-password"<5>
    volumes:<6>
      - "data-postgres:/var/lib/postgresql/data"
    healthcheck:<7>
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "5432:5432/tcp"<8>

  core:<9>
    image: opennms/horizon:{full-display-version}<10>
    depends_on:<11>
      database:
        condition: service_healthy
    environment:
      TZ: UTC<12>
      POSTGRES_HOST: database<13>
      POSTGRES_PORT: 5432<14>
      POSTGRES_USER: postgres<15>
      POSTGRES_PASSWORD: "my-postgres-password"<16>
      OPENNMS_DBNAME: opennms-core-db<17>
      OPENNMS_DBUSER: opennms<18>
      OPENNMS_DBPASS: "my-opennms-db-password"<19>
    volumes:
      - "data-opennms:/opennms-data"<20>
      - "data-config:/opt/opennms/etc"<21>
    command: ["-s"]
    ports:<22>
      - "8980:8980/tcp"
      - "8101:8101/tcp"
    healthcheck:
      test: [ "CMD", "curl", "-f", "-I", "http://localhost:8980/opennms/login.jsp" ]<23>
      interval: 10s
      timeout: 5s
      retries: 20
----

<1> Volume definitions to persist the {page-component-title} Core data, configuration files and PostgreSQL database
<2> The service for the PostgreSQL database
<3> Time zone setting for the service, you can adjust this to your local setting if needed, see `timedatectl list-timezones`
<4> Username for the PostgreSQL superuser
<5> Password for the PostgreSQL superuser
<6> Persistence for the PostgreSQL database
<7> Healthcheck for the database service
<8> Optional: Publish PostgreSQL port to 5432/tcp on the Docker host
<9> Service for the Core service
<10> Image name for the core service
<11> Wait for a healthy PostgreSQL service before start up
<12> Time zone setting for the service, you can adjust this to your local setting if needed, see `timedatectl list-timezones`
<13> Hostname or IP for the PostgreSQL database service
<14> Service port for the PostgreSQL database
<15> PostgreSQL superuser name
<16> PostgreSQL superuser password
<17> Database name for OpenNMS
<18> Database username for the OpenNMS database
<19> Password for the OpenNMS user
<20> Persist RRD files in a persistent volume
<21> Persist the configuration files in volume
<22> Publish ports for the Web user interface 8980/tcp and the SSH access for the Karaf Shell on 8101/tcp
<23> Service is healthy when we have access to the web user interface

NOTE: The process inside the container runs as a non-privileged user with user id `10001`.
      If you want the configuration files in a bind mount on your local host system, make sure you set permissions and ownership accordingly with `chown 10001:10001 ./path/to/my/config-dir`.

NOTE: The Java binary in the OCI container has the capability `CAP_NET_BIND_SERVICE=+ep CAP_NET_RAW=+ep` assigned.

TIP: To run a release candidate or a different version, use the public image tags from our repository on <<link:https://hub.docker.com/r/opennms/horizon/tags, DockerHub>>.

.Validate your Docker Compose file
[source, console]
----
docker compose config -q
----

.Startup the services
[source, console]
----
docker compose up -d
----
