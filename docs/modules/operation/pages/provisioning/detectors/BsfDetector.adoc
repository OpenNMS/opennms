= BSF Detector

The BSF Detector lets you run arbitrary scripts using the Bean Scripting Framework to determine the existence of a service.
This can be a script written in any of the languages BSF supports.
The only requirement is that the script returns the string `OK` if it passes.

The BSF Detector passes the `map`, `ip_addr`, `svc_name`, and `results` variables as beans to the script.

== Detector facts

[options="autowidth"]
|===
| Implementation | `org.opennms.netmgt.provision.detector.bsf.BSFDetector`
|===

== Configuration and Use

.Parameters for the BSF detector
[options="header, autowidth"]

|===
| Parameter        | Description                                                                                            | Required | Default value
| `fileName`       | The path to the file on the OpenNMS server which contains the BSF-compatible script to run.            | optional |
| `langClass`      | The short name of the language the script is written in. Choices: `jython`, `beanshell`, `groovy`, etc.     | optional | 
| `bsfEngine`     a| The BSF engine to use when running the script. Choices:

* `bsh.util.BeanShellBSFEngine`
* `org.codehaus.groovy.bsf.GroovyEngine`
* `org.apache.bsf.engines.jython.JythonEngine`                                                                                | optional | 
| `fileExtensions` | A comma-separated list of file extensions to consider a valid script for this BSF instance.            | optional | 
| `runType`       a| Which way to run the BSF script. Choices:

* `eval` - expects the script to print the OK/NOK status for validation
* `exec` - expects the script to manipulate the provided results hashmap directly                                           | optional | `eval`
|===

CAUTION: Avoid non-character names for parameters to avoid problems in the script languages.

== Timeout and Retry

The BSFDetector does not perform any timeout or retry processing on its own.
If retry and or timeout behavior is required, you must implement it in the script itself.

== Requirements for the script (run-types)

Depending on the `run-type`, the script has to provide its results in different ways.
For minimal scripts with very simple logic, `run-type` `eval` is the simple option.
Scripts running in `eval` mode have to return a string matching one of the `status codes`.

If your script is more than one line, `run-type` `exec` is required.
Scripts running in `exec` mode need not return anything, but they have to add a `status` entry with a `status code` to the _results_ object.
Additionally, the _results_ object can also carry a "reason":"message" entry that is used in non `OK` states.

== Commonly used language settings

The BSF detector supports many languages; the following table provides the required setup for commonly used languages.

.BSF language setups
[options="header, %autowidth"]
|===
| Language                            | lang-class  | bsf-engine                                    | required library
| http://www.beanshell.org[BeanShell] | beanshell | `bsh.util.BeanShellBSFEngine`                 | supported by default
| http://groovy.codehaus.org[Groovy]  | groovy  | `org.codehaus.groovy.bsf.GroovyEngine`        | +groovy-all-[version].jar+
| http://www.jython.org[Jython]       | jython   | `org.apache.bsf.engines.jython.JythonEngine`  | +jython-[version].jar+
|===


== Example Configurations

=== BeanShell Example

.BeanShell example
[source, xml]
----
<detector name="MinimalBeanShell" class="org.opennms.netmgt.provision.detector.bsf.BSFDetector">
    <parameter key="bsfEngine" value="bsh.util.BeanShellBSFEngine"/>
    <parameter key="langClass" value="beanshell"/>
    <parameter key="fileName" value="/opt/opennms/etc/scripts/MinimalBeanShell.bsh"/>
    <parameter key="runType" value="eval"/>
</detector>
----

.BeanShell example `MinimalBeanShell.bsh` script file
[source, java]
----
File testFile = new File("/tmp/TestFile");
if (testFile.exists()) {
  return "OK";
} else {
  results.put("reason", "file does not exist");
  return "NOK";
}
----

=== Groovy Example

.Groovy example for `run-type` `eval`
[source, xml]
----
<detector name="MinimalGroovy" class="org.opennms.netmgt.provision.detector.bsf.BSFDetector">
    <parameter key="bsfEngine" value="org.codehaus.groovy.bsf.GroovyEngine"/>
    <parameter key="langClass" value="groovy"/>
    <parameter key="fileName" value="/opt/opennms/etc/scripts/MinimalGroovy.groovy"/>
    <parameter key="runType" value="eval"/>
</detector>
----

.Groovy example `MinimalGroovy.groovy` script file for `run-type` `eval`
[source, java]
----
File testFile = new File("/tmp/TestFile");
if (testFile.exists()) {
  return "OK";
} else {
  results.put("reason", "file does not exist");
  return "NOK";
}
----

.Groovy example for `run-type` `exec`
[source, xml]
----
<detector name="MinimalGroovy" class="org.opennms.netmgt.provision.detector.bsf.BSFDetector">
    <parameter key="bsfEngine" value="org.codehaus.groovy.bsf.GroovyEngine"/>
    <parameter key="langClass" value="groovy"/>
    <parameter key="fileName" value="/opt/opennms/etc/scripts/MinimalGroovy.groovy"/>
    <parameter key="runType" value="exec"/>
</detector>

----

.Groovy example `MinimalGroovy.groovy` script file for `run-type` `exec`
[source, java]
----
def testFile = new File("/tmp/TestFile");
if (testFile.exists()) {
  results.put("status", "OK")
} else {
  results.put("reason", "file does not exist");
  results.put("status", "NOK");
}
----

=== Example Jython

To use the Jython (Java implementation of Python) language an additional library is required.
Copy a compatible `jython-x.y.z.jar` into the `opennms/lib` folder and restart {page-component-title}.
That makes Jython available for the BSF Detector.

.Jython example for `run-type` `exec`
[source, xml]
----
<detector name="MinimalJython" class="org.opennms.netmgt.provision.detector.bsf.BSFDetector">
    <parameter key="bsfEngine" value="org.apache.bsf.engines.jython.JythonEngine"/>
    <parameter key="langClass" value="jython"/>
    <parameter key="fileName" value="/opt/opennms/etc/scripts/MinimalJython.py"/>
    <parameter key="runType" value="exec"/>
</detector>
----

.Jython example `MinimalJython.py` script file for `run-type` `exec`
[source, python]
----
from java.io import File

if (File("/tmp/TestFile").exists()):
        results.put("status", "OK")
else:
        results.put("reason", "file does not exist")
        results.put("status", "NOK")
----

NOTE: We have to use `run-type` `exec` here because Jython chokes on the +import+ keyword in `eval` mode.

NOTE: As proof that this is really _Python_, notice the substitution of _Python's_ +None+ value for Java's +null+ in the log call.
