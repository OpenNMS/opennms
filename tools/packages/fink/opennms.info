Package: opennms
Version: 1.1.1
Revision: 1

CustomMirror: <<
  nam-US: ftp://ftp.opennms.org/pub/development/snapshots
  nam-US: http://ranger.befunk.com/fink
  nam-CA: http://www.southofheaven.net/befunk
<<
Source: ftp://ftp.opennms.org/pub/releases/OpenNMS/1.1/source/%n-%v-1.tar.gz
SourceDirectory: %n
#Patch: %f.patch

BuildDepends: ant (>= 1.5), postgresql73-dev | postgresql73-ssl-dev, tomcat (>= 4.1.18-4), commons-logging (>= 1.0.3), rrdtool (>= 1.0.40-2), passwd (>= 20030202-1)
Depends: postgresql73 | postgresql73-ssl, tomcat (>= 4.1.18-4), commons-logging (>= 1.0.3), rrdtool (>= 1.0.40-2), daemonic, passwd (>= 20030202-1), dbd-pg-pm (>= 1.21), getopt-mixed-pm
ConfFiles: <<
  %p/var/opennms/etc/actiond-configuration.xml
  %p/var/opennms/etc/capsd-configuration.xml
  %p/var/opennms/etc/categories.xml
  %p/var/opennms/etc/collectd-configuration.xml
  %p/var/opennms/etc/datacollection-config.xml
  %p/var/opennms/etc/destinationPaths.xml
  %p/var/opennms/etc/dhcpd-configuration.xml
  %p/var/opennms/etc/discovery-configuration.xml
  %p/var/opennms/etc/eventconf.xml
  %p/var/opennms/etc/eventd-configuration.xml
  %p/var/opennms/etc/events/3Com.events.xml
  %p/var/opennms/etc/events/APC.events.xml
  %p/var/opennms/etc/events/Brocade.events.xml
  %p/var/opennms/etc/events/CIM.events.xml
  %p/var/opennms/etc/events/Cisco.events.xml
  %p/var/opennms/etc/events/default.events.xml
  %p/var/opennms/etc/events/Fore.events.xml
  %p/var/opennms/etc/events/HP.events.xml
  %p/var/opennms/etc/events/Intel.events.xml
  %p/var/opennms/etc/events/Microsoft.events.xml
  %p/var/opennms/etc/events/Novell.events.xml
  %p/var/opennms/etc/events/Oracle.events.xml
  %p/var/opennms/etc/events/SonicWall.events.xml
  %p/var/opennms/etc/events/Standard.events.xml
  %p/var/opennms/etc/events/Xerox.events.xml
  %p/var/opennms/etc/events-archiver-configuration.xml
  %p/var/opennms/etc/events.archiver.properties
  %p/var/opennms/etc/exclude-ueis.properties
  %p/var/opennms/etc/groups.xml
  %p/var/opennms/etc/jcifs.properties
  %p/var/opennms/etc/log4j.properties
  %p/var/opennms/etc/magic-users.properties
  %p/var/opennms/etc/notifd-configuration.xml
  %p/var/opennms/etc/notificationCommands.xml
  %p/var/opennms/etc/notifications.xml
  %p/var/opennms/etc/opennms-database.xml
  %p/var/opennms/etc/opennms-mapping.xml
  %p/var/opennms/etc/outage-configuration.xml
  %p/var/opennms/etc/poll-outages.xml
  %p/var/opennms/etc/poller-config.properties
  %p/var/opennms/etc/poller-configuration.xml
  %p/var/opennms/etc/response-adhoc-graph.properties
  %p/var/opennms/etc/response-graph.properties
  %p/var/opennms/etc/rtc-configuration.xml
  %p/var/opennms/etc/service-configuration.xml
  %p/var/opennms/etc/snmp-adhoc-graph.properties
  %p/var/opennms/etc/snmp-config.xml
  %p/var/opennms/etc/snmp-graph.properties
  %p/var/opennms/etc/SVGAvailReport.xsl
  %p/var/opennms/etc/threshd-configuration.xml
  %p/var/opennms/etc/thresholds.xml
  %p/var/opennms/etc/trapd-configuration.xml
  %p/var/opennms/etc/users.xml
  %p/var/opennms/etc/viewsdisplay.xml
  %p/var/opennms/etc/vulnscand-configuration.xml
  %p/var/opennms/etc/webui-colors.xml
<<
CompileScript: <<
#!/bin/sh
  NEW_JDK=false
  for dir in `cd /System/Library/Frameworks/JavaVM.framework/Versions && ls -1 | grep 1`; do
    if test `echo $dir | cut -d. -f1` -eq 1; then
      if test `echo $dir | cut -d. -f2` -ge 4; then
        NEW_JDK=true
      fi
    elif test `echo $dir | cut -d. -f1` -gt 1; then
      NEW_JDK=true
    fi
  done
  if [ "$NEW_JDK" = "false" ]; then
    echo "You must have the 1.4 JDK or higher to run OpenNMS!"
    echo "You can download it from http://connect.apple.com/"
    exit 1
  fi

  # opennms will find it's own stuff
  export CLASSPATH=""
  rm -rf work dist
  sed -e 's:@PREFIX@:%p:g' -e 's:@DESTDIR@:%d:g' < tools/packages/fink/build.properties > build.properties
  ./build.sh compile
<<
InstallScript: <<
#!/bin/sh
  # main install
  ./build.sh install

  # some convenience symlinks
  install -d -m 755 %i/etc
  ln -sf %p/var/opennms/etc %i/etc/opennms
  ln -sf %p/var/log/opennms %i/var/opennms/logs

  # put in the symlinks so tomcat can find classes
  install -d -m 755 %i/var/tomcat4/server/lib
  for jar in \
	castor-0.9.3.9.jar \
	log4j.jar \
	opennms_common.jar \
	opennms_core.jar \
	opennms_joesnmp.jar \
	opennms_services.jar \
	opennms_web.jar \
	postgresql.jar; do
    ln -sf %p/var/opennms/lib/$jar %i/var/tomcat4/server/lib/
  done

  # make a config to add to tomcat for startup
  install -d -m 755 %i/var/tomcat4/conf
  cat <<END > %i/var/tomcat4/conf/opennms.conf
CLASSPATH="%p/var/opennms/etc:$CLASSPATH" export CLASSPATH
DYLD_LIBRARY_PATH="%p/var/opennms/lib:$DYLD_LIBRARY_PATH" export DYLD_LIBRARY_PATH
END

  # fix ownership so tomcat can write to log dirs
  chown -R opennms:tomcat %i/var/opennms %i/var/log/opennms %i/var/tomcat4/webapps/opennms %i/var/tomcat4/conf/*
  chmod -R g+w %i/var/opennms/etc %i/var/log/opennms %i/var/tomcat4/conf/*
  chmod g+s %i/var/log/opennms %i/var/opennms/etc

<<
DaemonicFile: <<
<service>
 <description>OpenNMS</description>
 <message>OpenNMS Network Management</message>
 <daemon name="opennms">
  <executable background="no">/usr/bin/sudo</executable>
  <parameters>%p/bin/opennms start</parameters>
 </daemon>
</service>
<<

PreInstScript: <<
#!/bin/sh
  NEW_JDK=false
  for dir in `cd /System/Library/Frameworks/JavaVM.framework/Versions && ls -1 | grep 1`; do  
    if test `echo $dir | cut -d. -f1` -eq 1; then  
      if test `echo $dir | cut -d. -f2` -ge 4; then
        NEW_JDK=true
      fi
    elif test `echo $dir | cut -d. -f1` -gt 1; then  
      NEW_JDK=true
    fi
  done

  if [ "$NEW_JDK" = "false" ]; then
    echo "You must have the 1.4 JDK or higher to run OpenNMS!"
    echo "You can download it from http://connect.apple.com/"
    exit 1
  fi
<<

PostInstScript: <<
# update daemonic init script if necessary
daemonic install opennms

cat <<END
*** NOTE ***

This package will not work until you follow the post-installation
instructions in %p/share/doc/%n/README.Darwin
END
<<
PreRmScript: <<
# clean up
if [ $1 != "upgrade" ]; then
  daemonic remove opennms
  rm -rf %p/var/log/opennms/*
fi
<<

RuntimeVars: OPENNMS_HOME: %p/var/opennms
Homepage: http://www.opennms.org/
Maintainer: Benjamin Reed <ranger@befunk.com>
Description: Network Management System
DocFiles: tools/packages/fink/README.Darwin
DescDetail: <<
OpenNMS is an open-source, enterprise-level network management system
along the lines of HP's OpenView line of network management tools, or
IBM's Tivoli.
<<
DescUsage: <<
To start, stop, or restart OpenNMS, do:

  sudo %p/bin/opennms <command>

To enable OpenNMS to start upon bootup, issue the command:

  sudo daemonic enable opennms

Note that for this to work properly, you must also enable PostgreSQL
and Tomcat as well!
<<
License: GPL
