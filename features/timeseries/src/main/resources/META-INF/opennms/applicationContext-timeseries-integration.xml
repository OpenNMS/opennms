<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:onmsgi="http://xmlns.opennms.org/xsd/spring/onms-osgi"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd
       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd
       http://xmlns.opennms.org/xsd/spring/onms-osgi http://xmlns.opennms.org/xsd/spring/onms-osgi.xsd
       ">

  <context:annotation-config />

  <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer" />

  <!-- Influx DB -->
  <bean id="influxdb.bucket" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.influxdb.bucket:opennms}" />
  </bean>
  <bean id="influxdb.org" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.influxdb.bucket:opennms}" />
  </bean>
  <bean id="influxdb.token" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.influxdb.token:unknown}" />
  </bean>
  <bean id="influxdb.url" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.influxdb.url:http://localhost:9999}" />
  </bean>

 <!-- timeseries integration layer -->
  <bean id="timeseries.max_batch_size" class="java.lang.Integer">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.max_batch_size:16}" />
  </bean>
  <bean id="timeseries.ring_buffer_size" class="java.lang.Integer">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.ring_buffer_size:8192}" />
  </bean>

  <bean id="timeseries.writer_threads" class="java.lang.Integer">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.writer_threads:16}" />
  </bean>

  <bean id="samples.cassandra.time-to-live" class="java.lang.Integer">
        <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.ttl:31540000}" />
  </bean>

  <bean id="cache.priming.disable" class="java.lang.Boolean">
    <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.cache.priming.disable:false}"/>
  </bean>

  <bean id="cache.priming.block_ms" class="java.lang.Long">
    <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.cache.priming.block_ms:120000}"/>
  </bean>

  <bean id="cache.priming.fetch_size" class="java.lang.Integer">
    <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.cache.priming.fetch_size:10000}" />
  </bean>

  <bean id="cache.priming.fetch_more_threshold" class="java.lang.Integer">
    <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.cache.priming.fetch_more_threshold:1000}" />
  </bean>

  <!--
     The cassandraIndexer bean fails to load with the following exception when using
     this definition:
        No qualifying bean of type [int] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency. Dependency annotations: {@javax.inject.Named(value=search.cassandra.time-to-live)}

     So instead, we resort to the static value bellow:

    <bean id="search.cassandra.time-to-live" class="java.lang.Integer">
          <constructor-arg type="java.lang.String" value="${org.opennms.newts.config.ttl:31536000}" />
    </bean>
  -->

  <util:constant id="search.cassandra.time-to-live" static-field="org.opennms.netmgt.timeseries.integration.support.TimeseriesUtils.TTL" />

  <util:constant id="cassandraIndexingOptions" static-field="org.opennms.netmgt.timeseries.integration.support.TimeseriesUtils.INDEXING_OPTIONS" />

  <bean id="sampleProcessor.maxThreads" class="java.lang.Integer">
        <!-- This options should always match the number of writer threads. See NMS-8439. -->
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.writer_threads:16}" />
  </bean>

  <bean id="search.resourceMetadata.maxCacheEntries" class="java.lang.Long">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.cache.max_entries:8192}" />
  </bean>

  <bean id="redis.hostname" class="java.lang.String">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.cache.redis_hostname:localhost}" />
  </bean>

  <bean id="redis.port" class="java.lang.Integer">
        <constructor-arg type="java.lang.String" value="${org.opennms.timeseries.config.cache.redis_port:6379}" />
  </bean>

  <bean id="contextConfigurations" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="staticMethod" value="org.opennms.netmgt.timeseries.integration.support.ContextConfigurationFactory.getContextConfigurations"/>
  </bean>
  <bean id="timeseriesMetricRegistry" class="com.codahale.metrics.MetricRegistry"/><!-- TODO Patrick: discuss with Jesse: do we still need this? Its also used for the GuavaSearchableResourceMetadataCache-->

  <bean id="timeseriesMetricRegistryJmxReporterBuilder" class="com.codahale.metrics.JmxReporter" factory-method="forRegistry">
      <constructor-arg ref="timeseriesMetricRegistry"/><!-- TODO Patrick: discuss with Jesse: do we still need this? -->
  </bean>

  <bean id="timeseriesMetricRegistryDomainedJmxReporterBuilder" factory-bean="timeseriesMetricRegistryJmxReporterBuilder" factory-method="inDomain">
      <constructor-arg value="org.opennms.newts"/><!-- TODO Patrick: discuss with Jesse: do we still need this? -->
  </bean>

  <bean id="timeseriesMetricRegistryJmxReporter"
        factory-bean="timeseriesMetricRegistryDomainedJmxReporterBuilder"
        factory-method="build"
        init-method="start"
        destroy-method="stop" /><!-- TODO Patrick: discuss with Jesse: do we still need this? -->

  <bean id="resourceIdSplitter" class="org.opennms.newts.cassandra.search.EscapableResourceIdSplitter" />

  <bean id="timeseriesSearcher" class="org.opennms.netmgt.timeseries.integration.dao.TimeseriesSearcher" />

  <bean id="resourceMetadataCache" class="${org.opennms.timeseries.config.cache.strategy:org.opennms.netmgt.timeseries.integration.support.GuavaSearchableResourceMetadataCache}" />

  <bean id="newtsWriter" class="org.opennms.netmgt.timeseries.integration.TimeseriesWriter" />

  <bean id="timeseriesStorage" class="${org.opennms.timeseries.impl:org.opennms.netmgt.timeseries.impl.memory.InMemoryStorage}"/>

  <bean id="timeSeriesMetaDataDao" class="org.opennms.netmgt.timeseries.meta.TimeSeriesMetaDataDao" />

  <bean id="resourceStorageDao" primary="true" class="org.opennms.netmgt.timeseries.integration.dao.TimeseriesResourceStorageDao" />

  <onmsgi:service interface="org.opennms.netmgt.dao.api.ResourceStorageDao" ref="resourceStorageDao" />

  <bean id="timeseriesPersisterFactory" class="org.opennms.netmgt.timeseries.integration.persistence.TimeseriesPersisterFactory" />

  <bean id="osgiPersisterFactory" class="org.opennms.features.collection.persistence.osgi.OsgiPersisterFactory" />

  <bean id="delegatingPersisterFactory" class="org.opennms.netmgt.collection.support.DelegatingPersisterFactory" primary="true" >
    <constructor-arg index="0" ref="timeseriesPersisterFactory"/>
    <constructor-arg index="1" ref="osgiPersisterFactory"/>
  </bean>

  <onmsgi:service interface="org.opennms.netmgt.collection.api.PersisterFactory" ref="delegatingPersisterFactory">
    <onmsgi:service-properties>
      <entry>
        <key><value>strategy</value></key>
        <value>delegate</value>
      </entry>
    </onmsgi:service-properties>
  </onmsgi:service>

  <!-- Some beans still require an RrdStrategy -->
  <bean id="rrdStrategy" primary="true" class="org.opennms.netmgt.rrd.NullRrdStrategy" />

  <onmsgi:service ref="rrdStrategy" interface="org.opennms.netmgt.rrd.RrdStrategy" />

</beans>
