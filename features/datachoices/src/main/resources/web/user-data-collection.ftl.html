<!-- User Data Collection form -->
<style>
    #user-data-collection-alert.alert {
		/* ensure alert is above the geomap */
		z-index: 1000;
    }

    #user-data-collection-alert h5.modal-title {
        color: #265a87;
    }

    #user-data-collection-alert .modal-header {
        background-color: #e9ecef;
    }

    #user-data-collection-alert .alert-dialog {
       position: fixed;
       top: 1rem;
       right: auto;
       left: max(calc(60% - 450px), 1px);
       bottom: auto;
       min-width: 600px;
       max-width: 700px;
       box-shadow: 1px 3px 3px #6c757d;
    }

    #user-data-collection-alert-body.modal-body {
        padding: 0.25rem 1rem 1rem 1rem;
    }

    .alert-dialog .modal-content .modal-header {
        border-bottom: none;
    }

    .user-data-collection-content, #user-data-collection-done {
        color: #738198;
        font-size: 0.875rem;
    }

    .udc-form-field {
        margin-bottom: 1.2rem;
    }

    .udc-form-field label {
        margin-bottom: 0.25rem;
    }

    .udc-form-required {
        color: red;
    }

    .udc-fieldset-form-columns-1 .udc-form-field {
        width: 100%;
    }

    .udc-fieldset-form-columns-2 .udc-form-field {
        width: 50%;
        float: left;
    }

    .udc-fieldset-form-columns-2 .udc-form-field.udc-form-field-left .udc-input-wrapper {
        margin-right: 8px;
    }

    .udc-form-fieldset input.udc-input {
        background-clip: padding-box;
        background-color: #f5f8fa;
        border: 1px solid #cbd6e2;
        border-radius: 15px;
        box-sizing: border-box;
        color: #33475b;
        height: 40px;
        min-height: 27px;
        max-width: 100%;
        width: 100%;
        font-size: 1.1rem;
        font-weight: normal;
        line-height: 1.2rem;
        padding: 0 1.1rem;
    }

    .udc-form-fieldset input.udc-input:focus {
        border-color: rgba(82, 168, 236, .8);
        outline: none;
    }

    .udc-form-fieldset .udc-form-field span {
        font-size: 1.1rem;
        font-weight: 500;
        line-height: 1.2rem;
    }

    .udc-required-msg {
        color: red;
        font-size: 1.1rem;
        font-weight: normal;
        line-height: 1.2rem;
        margin-top: 0.25rem;
    }

    .udc-required-msg-hidden {
        display: none;
    }

    .udc-legal-text {
        color: #738198;
        font-size: 0.75rem;
    }

    .udc-form-required.udc-legal-text,
    .udc-legal-text.udc-required-msg {
        color: red;
    }

    .udc-form-field input[type=checkbox] {
        vertical-align: middle;
    }

    .user-data-collection-button {
        border-radius: 0;
		box-shadow: none;
        font-size: 0.875rem;
        font-weight: 700;
        letter-spacing: 0.2em;
        line-height: 1.25rem;
        text-transform: uppercase;
    }

	.user-data-collection-submit-button, .user-data-collection-close-button {
        background-color: #273180;
        border: 2px solid transparent;
        color: #fff;
        margin-right: 1rem;
    }

    .user-data-collection-submit-button:hover, .user-data-collection-close-button:hover {
        box-shadow: 3px 1px 2px #6c757d;
        color: #fff;
    }

	.user-data-collection-dismiss-button {
        border: 2px solid;
        color: #273180;
    }

    .user-data-collection-dismiss-button:hover {
        box-shadow: 3px 1px 2px #6c757d;
    }

    .user-data-collection-sending, .user-data-collection-error {
        background-color: #e9ecef;
        border: 1px solid #cbd6e2;
        border-radius: 15px;
        margin-top: 4px;
        width: 100%;
        font-size: 1.1rem;
        line-height: 1.2rem;
        padding: 4px;
    }

    .user-data-collection-sending .udc-sending-data {
        color: #0c0;
    }

    .user-data-collection-error {
        color: red;
    }
</style>

<div class="alert alert-dismissable" id="user-data-collection-alert" tabindex="-1" role="alert">
    <div class="alert-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Update Sign Up</h5>
            </div>
            <div id="user-data-collection-alert-body" class="modal-body">
                <div class="user-data-collection-content">
                    Now that you're part of the OpenNMS community, let's stay in touch!
                    Share your info and we'll keep you up to date on the latest from
                    OpenNMS Horizon and Meridian as well as our upcoming cloud hosted solution, Lokahi.

                    This notice will only display once, but you can visit <a href="admin/user-data-collection/index.jsp">here</a> to re-enable sign up.
                </div>
                <br />
                <div id="user-data-collection-form-wrapper">
                    <form id="user-data-collection-form">
                        <fieldset class="udc-form-fieldset udc-fieldset-form-columns-2">
                            <div class="udc-form-field udc-form-field-left">
                                <label for="udcFirstName">
                                    <span>First Name</span>
                                    <span class="udc-form-required">*</span>
                                </label>
                                <div class="udc-input-wrapper">
                                    <input type="text" name="firstName" id="udcFirstName" class="udc-input"></input>
                                </div>
                                <div class="udc-required-msg udc-required-msg-hidden">Please complete this required field.</div>
                            </div>
                            <div class="udc-form-field">
                                <label for="udcLastName">
                                    <span>Last Name</span>
                                    <span class="udc-form-required">*</span>
                                </label>
                                <div class="udc-input-wrapper">
                                    <input type="text" name="lastName" id="udcLastName" class="udc-input"></input>
                                </div>
                                <div class="udc-required-msg udc-required-msg-hidden">Please complete this required field.</div>
                            </div>
                        </fieldset>
                        <fieldset class="udc-form-fieldset udc-fieldset-form-columns-1">
                            <div class="udc-form-field">
                                <label for="udcEmail">
                                    <span>Email Address</span>
                                    <span class="udc-form-required">*</span>
                                </label>
                                <div class="udc-input-wrapper">
                                    <input type="text" name="email" id="udcEmail" class="udc-input"></input>
                                </div>
                                <div class="udc-required-msg udc-required-msg-hidden">Please complete this required field.</div>
                            </div>
                        </fieldset>
                        <fieldset class="udc-form-fieldset udc-fieldset-form-columns-1">
                            <div class="udc-form-field">
                                <label for="udcCompany">
                                    <span>Company Name</span>
                                    <span class="udc-form-required">*</span>
                                </label>
                                <div class="udc-input-wrapper">
                                    <input type="text" name="company" id="udcCompany" class="udc-input"></input>
                                </div>
                                <div class="udc-required-msg udc-required-msg-hidden">Please complete this required field.</div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <p class="udc-legal-text">${legalConsentCommunication}</p>
                        </fieldset>
                        <fieldset>
                            <div class="udc-form-field">
                                <input type="checkbox" name="consent" id="udcConsent"></input>
                                <span class="udc-legal-text">${consentText}</span>
                                <span class="udc-form-required udc-legal-text">*</span>
                                <div class="udc-required-msg udc-legal-text udc-required-msg-hidden">Please complete this required field.</div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <div class="udc-legal-text">For more information, check out our <a href="https://www.opennms.com/privacy/">Privacy Policy</a>.</div>
                        </fieldset>
                        <fieldset>
                            <div class="udc-legal-text">Required fields are marked with a <span class="udc-form-required udc-legal-text">*</span></div>
                        </fieldset>
                    </form>
                </div>
                <div id="user-data-collection-done" style="display: none;">
                    <p>Thank you for submitting your information.</p>
                    <p>Welcome to the Horizon Community! Feel free to browse our
                    <a href="https://www.opennms.com/blog/">blog</a> or follow us on our socials.</p>
                    <p>
                        <a href="https://www.linkedin.com/company/the-opennms-group/">LinkedIn</a> |
                        <a href="http://www.twitter.com/opennms">Twitter</a> |
                        <a href="https://www.facebook.com/OpenNMS/">Facebook</a> |
                        <a href="http://www.youtube.com/user/opennms">YouTube</a> |
                        <a href="http://www.reddit.com/r/opennms">Reddit</a> |
                        <a href="https://chat.opennms.com/">Mattermost Chat</a> |
                        <a href="https://opennms.discourse.group/">Discourse</a>
                    </p>
                </div>
                <div class="user-data-collection-sending" style="display: none;">
                    <span class="udc-sending-data">Sending data...</span>
                </div>
                <div class="user-data-collection-error" style="display: none;">
                    <span>There was an error processing your request. You may click Opt Out to close this window.</span>
                </div>
                <br />
                <div class="user-data-collection-buttons">
                    <input type="hidden" id="user-data-collection-opted-in" value="false"></input>
                    <input type="hidden" id="user-data-collection-acked" value="false"></input>
                    <button id="user-data-collection-notice-submit" type="button" class="btn user-data-collection-button user-data-collection-submit-button">Sign Up</button>
                    <button id="user-data-collection-notice-dismiss" type="button" class="btn user-data-collection-button user-data-collection-dismiss-button" data-dismiss="alert">Opt Out</button>
                    <button id="user-data-collection-notice-close" type="button" class="btn user-data-collection-button user-data-collection-close-button" style="display: none;" data-dismiss="alert">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
(function() {
    function userDataCollectionAckInitialNotice() {
        var acked = $('#user-data-collection-acked').val();

        if (acked === 'true') {
            // already acked
            return;
        }

        var optedIn = $('#user-data-collection-opted-in').val();
        var data = { optedIn: optedIn === 'true', noticeAcknowledged: true };

        $.ajax({
            url: 'rest/datachoices/userdatacollection/status',
            method: 'POST',
            dataType: null,
            contentType: 'application/json',
            processData: false,
            data: JSON.stringify(data)
        })
        .done(function() {
            console.log('User Data Collection notice acknowledged, opt-in: ' + optedIn);
        })
        .fail(function() {
            console.error('User Data Collection notice acknowledgement failed, opt-in: ' + optedIn);
        });
    }

    function userDataCollectionSubmitForm() {
        $('.user-data-collection-error').hide();

        var firstName = $('#udcFirstName').val();
        var lastName = $('#udcLastName').val();
        var email = $('#udcEmail').val();
        var company = $('#udcCompany').val();
        var consent = $('#udcConsent').is(':checked');

        if ([firstName, lastName, email, company, consent].some(function(x) { return !x; })) {
            $('.udc-required-msg').removeClass('udc-required-msg-hidden');
            return false;
        }

        $('.udc-required-msg').addClass('udc-required-msg-hidden');

        var data = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            company: company,
            consent: true
        };

        $('.user-data-collection-sending').show();

        $.ajax({
            url: 'rest/datachoices/userdatacollection/submit',
            method: 'POST',
            dataType: null,
            contentType: 'application/json',
            processData: false,
            data: JSON.stringify(data)
        })
        .done(function() {
            $('#user-data-collection-opted-in').val('true');
            $('.user-data-collection-content').hide();
            $('#user-data-collection-form-wrapper').hide();
            $('#user-data-collection-notice-submit').hide();
            $('#user-data-collection-notice-dismiss').hide();

            $('#user-data-collection-done').show();
            $('#user-data-collection-notice-close').show();

            userDataCollectionAckInitialNotice();
            $('#user-data-collection-acked').val('true');
        })
        .fail(function() {
            $('#user-data-collection-opted-in').val('false');
            $('.user-data-collection-error').show();
            alert('There was an error processing your request.');
        })
        .always(function() {
            $('.user-data-collection-sending').hide();
        });

        return false;
    }

    $(document).ready(function() {
        $('#user-data-collection-notice-dismiss').click(function() {
            userDataCollectionAckInitialNotice();
        });

        $('#user-data-collection-notice-submit').click(function(e) {
            e.preventDefault();
            userDataCollectionSubmitForm();
        });

        $('#user-data-collection-alert').alert();
    });
})();
</script>
