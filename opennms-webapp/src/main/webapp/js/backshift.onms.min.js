/*! backshift 1.0.1-SNAPSHOT - built on 2015-07-28 */
Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};return fNOP.prototype=this.prototype,fBound.prototype=new fNOP,fBound});var Backshift=Backshift||{};Backshift.namespace=function(ns_string){var i,parts=ns_string.split("."),parent=Backshift;for("Backshift"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)"undefined"==typeof parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent},Backshift.keys=function(obj){var keys=[];for(var key in obj)obj.hasOwnProperty(key)&&keys.push(key);return keys},Backshift.extend=function(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property]);return destination},Backshift.rows=function(matrix){var ncols=matrix.length;if(0===ncols)return[];for(var nrows=matrix[0].length,rows=new Array(nrows),i=0;nrows>i;i++){for(var row=new Array(ncols),j=0;ncols>j;j++)row[j]=matrix[j][i];rows[i]=row}return rows},Backshift.fail=function(msg){throw console.log("Error: "+msg),"Error: "+msg},Backshift.clone=function(obj){return JSON.parse(JSON.stringify(obj))},function(globalContext){function isFunction(object){return _toString.call(object)===FUNCTION_CLASS}function extend(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property]);return destination}function keys(object){var results=[];for(var property in object)object.hasOwnProperty(property)&&results.push(property);return results}function isUndefined(object){return"undefined"==typeof object}function argumentNames(fn){var names=fn.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=names.length||names[0]?names:[]}function wrap(fn,wrapper){var __method=fn;return function(){var a=update([bind(__method,this)],arguments);return wrapper.apply(this,a)}}function update(array,args){for(var arrayLength=array.length,length=args.length;length--;)array[arrayLength+length]=args[length];return array}function merge(array,args){return array=slice.call(array,0),update(array,args)}function bind(fn,context){if(arguments.length<2&&isUndefined(arguments[0]))return this;var __method=fn,args=slice.call(arguments,2);return function(){var a=merge(args,arguments);return __method.apply(context,a)}}var _toString=Object.prototype.toString,FUNCTION_CLASS="[object Function]",slice=Array.prototype.slice,emptyFunction=function(){},Class=function(){function subclass(){}function create(){function klass(){this.initialize.apply(this,arguments)}var parent=null,properties=[].slice.apply(arguments);if(isFunction(properties[0])&&(parent=properties.shift()),extend(klass,Class.Methods),klass.superclass=parent,klass.subclasses=[],parent){subclass.prototype=parent.prototype,klass.prototype=new subclass;try{parent.subclasses.push(klass)}catch(e){}}for(var i=0,length=properties.length;length>i;i++)klass.addMethods(properties[i]);return klass.prototype.initialize||(klass.prototype.initialize=emptyFunction),klass.prototype.constructor=klass,klass}function addMethods(source){var ancestor=this.superclass&&this.superclass.prototype,properties=keys(source);IS_DONTENUM_BUGGY&&(source.toString!=Object.prototype.toString&&properties.push("toString"),source.valueOf!=Object.prototype.valueOf&&properties.push("valueOf"));for(var i=0,length=properties.length;length>i;i++){var property=properties[i],value=source[property];if(ancestor&&isFunction(value)&&"$super"==argumentNames(value)[0]){var method=value;value=wrap(function(m){return function(){return ancestor[m].apply(this,arguments)}}(property),method),value.valueOf=bind(method.valueOf,method),value.toString=bind(method.toString,method)}this.prototype[property]=value}return this}var IS_DONTENUM_BUGGY=function(){for(var p in{toString:1})if("toString"===p)return!1;return!0}();return{create:create,Methods:{addMethods:addMethods}}}();globalContext.exports?globalContext.exports.Class=Class:globalContext.Class=Class}(Backshift),Backshift.namespace("Backshift.Class.Configurable"),Backshift.Class.Configurable=Backshift.Class.create({configure:function(args){args=args||{},Backshift.keys(this.defaults()).forEach(function(key){return args.hasOwnProperty(key)?void(null!==this.defaults()[key]&&"object"==typeof this.defaults()[key]?Backshift.keys(this.defaults()[key]).forEach(function(k){this[key][k]=void 0!==args[key][k]?args[key][k]:void 0!==this[key][k]?this[key][k]:this.defaults()[key][k]},this):this[key]=void 0!==args[key]?args[key]:void 0!==this[key]?this[key]:this.defaults()[key]):void(this[key]=this[key]||this.defaults()[key])},this)}}),Backshift.namespace("Backshift.Utilities.RpnToJexlConverter"),Backshift.Utilities.RpnToJexlConverter=Backshift.Class.create({initialize:function(){this.operators={},this._buildOperators()},_buildOperators:function(){var simpleOp=function(op){return function(stack){var b=stack.pop(),a=stack.pop();return"("+a+" "+op+" "+b+")"}},funcOp=function(op,numArgs){return function(stack){var i,ret=op+"(";for(i=0;numArgs>i;i++)ret+=stack.pop()+",";return ret.substring(0,ret.length-1)+")"}},ifOp=function(stack){var c=stack.pop(),b=stack.pop(),a=stack.pop();return"("+a+" != 0 ? "+b+" : "+c+")"},unOp=function(stack){var a=stack.pop();return"( ("+a+" == NaN) ? 1 : 0)"},infOp=function(stack){var a=stack.pop();return"( ("+a+" == __inf) || ("+a+" == __neg_inf) ? 1 : 0)"},booleanOp=function(op){return function(stack){var b=stack.pop(),a=stack.pop();return"("+a+" "+op+" "+b+" ? 1 : 0)"}},limitOp=function(stack){var max=stack.pop(),min=stack.pop(),val=stack.pop();return"( ( ("+min+" == __inf) || ("+min+" == __neg_inf) || ("+max+" == __inf) || ("+max+" == __neg_inf) || ("+val+" == __inf) || ("+val+" == __neg_inf) || ("+val+" < "+min+") || ("+val+" > "+max+") ) ? null : "+val+" )"},minMaxNanOp=function(op){return function(stack){var b=stack.pop(),a=stack.pop();return"( ( "+a+" == NaN ) ? "+b+" : ( ( "+b+" == NaN ) ? "+a+" : ( "+op+"("+b+","+a+") ) ) )"}},addNanOp=function(stack){var b=stack.pop(),a=stack.pop();return"( ( ( "+a+" == NaN ) && ( "+b+" == NaN ) ) ? NaN : ( ( "+a+" == NaN ) ? "+b+" : ( ( "+b+" == NaN ) ? "+a+" : ( "+a+" + "+b+" ) ) ) )"},atan2Op=function(stack){var x=stack.pop(),y=stack.pop();return"math:atan2("+y+","+x+")"};this.operators["+"]=simpleOp("+"),this.operators["-"]=simpleOp("-"),this.operators["*"]=simpleOp("*"),this.operators["/"]=simpleOp("/"),this.operators["%"]=simpleOp("%"),this.operators.IF=ifOp,this.operators.UN=unOp,this.operators.LT=booleanOp("<"),this.operators.LE=booleanOp("<="),this.operators.GT=booleanOp(">"),this.operators.GE=booleanOp(">="),this.operators.EQ=booleanOp("=="),this.operators.NE=booleanOp("!="),this.operators.MIN=funcOp("math:min",2),this.operators.MAX=funcOp("math:max",2),this.operators.MINNAN=minMaxNanOp("math:min"),this.operators.MAXNAN=minMaxNanOp("math:max"),this.operators.ISINF=infOp,this.operators.LIMIT=limitOp,this.operators.ADDNAN=addNanOp,this.operators.SIN=funcOp("math:sin",1),this.operators.COS=funcOp("math:cos",1),this.operators.LOG=funcOp("math:log",1),this.operators.EXP=funcOp("math:exp",1),this.operators.SQRT=funcOp("math:sqrt",1),this.operators.ATAN=funcOp("math:atan",1),this.operators.ATAN2=atan2Op,this.operators.FLOOR=funcOp("math:floor",1),this.operators.CEIL=funcOp("math:ceil",1),this.operators.RAD2DEG=funcOp("math:toDegrees",1),this.operators.DEG2RAD=funcOp("math:toRadians",1),this.operators.ABS=funcOp("math:abs",1),this.operators.UNKN=function(){return"NaN"},this.operators.INF=function(){return"__inf"},this.operators.NEGINF=function(){return"__neg_inf"}},convert:function(rpn){var token,tokens,n,i,stack=[];for(tokens=rpn.split(","),n=tokens.length,i=0;n>i;i++)token=tokens[i],this._isOperator(token)?stack.push(this._toExpression(token,stack)):stack.push(token);return 1===stack.length?stack.pop():void Backshift.fail("Too many input values in RPN express. RPN: "+rpn+" Stack: "+JSON.stringify(stack))},_isOperator:function(token){return token in this.operators},_toExpression:function(token,stack){return this.operators[token](stack)}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphVisitor=Backshift.Class.create({initialize:function(args){this.onInit(args)},onInit:function(args){},_visit:function(graphDef){var i,args,command,name,path,dsName,consolFun,rpnExpression,subParts,width,srcName,color,legend,CommandLineParser=function(){var parse=function(str,lookForQuotes){for(var args=[],readingPart=!1,part="",n=str.length,i=0;n>i;i++)" "!==str.charAt(i)||readingPart?'"'===str.charAt(i)&&lookForQuotes?(readingPart=!readingPart,part+=str.charAt(i)):part+=str.charAt(i):(args.push(part),part="");return args.push(part),args};return{parse:parse}}(),parts=CommandLineParser.parse(graphDef.command,!0),n=parts.length;for(i=0;n>i;i++){if(0===parts[i].indexOf("--")){if(args=/--(.*)=(.*)/.exec(parts[i]),null===args)continue;"title"===args[1]?this._onTitle(this._displayString(args[2])):"vertical-label"===args[1]&&this._onVerticalLabel(this._displayString(args[2]))}args=parts[i].split(":"),command=args[0],"DEF"===command?(subParts=args[1].split("="),name=subParts[0],path=subParts[1],dsName=args[2],consolFun=args[3],this._onDEF(name,path,dsName,consolFun)):"CDEF"===command?(subParts=args[1].split("="),name=subParts[0],rpnExpression=subParts[1],this._onCDEF(name,rpnExpression)):command.match(/LINE/)?(width=parseInt(/LINE(\d+)/.exec(command)),subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onLine(srcName,color,legend,width)):"AREA"===command?(subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onArea(srcName,color,legend)):"STACK"===command&&(subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onStack(srcName,color,legend))}},_onTitle:function(title){},_onVerticalLabel:function(label){},_onDEF:function(name,path,dsName,consolFun){},_onCDEF:function(name,rpnExpression){},_onLine:function(srcName,color,legend,width){},_onArea:function(srcName,color,legend){},_onStack:function(srcName,color,legend){},_displayString:function(string){return void 0===string?string:(string=string.replace(/"/g,""),string=string.replace("\\n",""),string=string.replace(/(.*)(\\)/,"$1"),string=string.trim())}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphConverter=Backshift.Class.create(Backshift.Utilities.RrdGraphVisitor,{onInit:function(args){this.graphDef=args.graphDef,this.resourceId=args.resourceId,this.model={metrics:[],series:[]},this.rpnConverter=new Backshift.Utilities.RpnToJexlConverter;var propertyValue,i,n=this.graphDef.propertiesValues.length;for(i=0;n>i;i++){propertyValue=this.graphDef.propertiesValues[i];var re=new RegExp("\\{"+propertyValue+"}","g");this.graphDef.command=this.graphDef.command.replace(re,propertyValue)}this._visit(this.graphDef);var nonTransientMetrics={};for(n=this.model.series.length,i=0;n>i;i++)nonTransientMetrics[this.model.series[i].metric]=1;var metric;for(n=this.model.metrics.length,i=0;n>i;i++)metric=this.model.metrics[i],metric["transient"]=!(metric.name in nonTransientMetrics)},_onTitle:function(title){this.model.title=title},_onVerticalLabel:function(label){this.model.verticalLabel=label},_onDEF:function(name,path,dsName,consolFun){var columnIndex=parseInt(/\{rrd(\d+)}/.exec(path)[1])-1,attribute=this.graphDef.columns[columnIndex];this.model.metrics.push({name:name,resourceId:this.resourceId,attribute:attribute,aggregation:consolFun})},_onCDEF:function(name,rpnExpression){this.model.metrics.push({name:name,expression:this.rpnConverter.convert(rpnExpression)})},_onLine:function(srcName,color,legend,width){this.model.series.push({name:legend,metric:srcName,type:"line",color:color})},_onArea:function(srcName,color,legend){this.model.series.push({name:legend,metric:srcName,type:"area",color:color})},_onStack:function(srcName,color,legend){this.model.series.push({name:legend,metric:srcName,type:"stack",color:color})}}),Backshift.namespace("Backshift.Graph"),Backshift.Graph=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(args){void 0===args.dataSource&&Backshift.fail("Graph needs a data source."),this.dataSource=args.dataSource,void 0===args.element&&Backshift.fail("Graph needs an element."),this.element=args.element,this.series=args.series,this.configure(args),0===this.start&&0===this.end&&0===this.last&&Backshift.fail("Graph needs start and end, or last to be non-zero."),this.queryInProgress=!1,this.lastSuccessfulQuery=0,this.timer=null,this.onInit(args)},defaults:function(){return{width:400,height:240,resolution:0,start:0,end:0,last:0,refreshRate:0,checkInterval:15e3}},render:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null),this.onRender(),this.refresh(),this.createTimer()},resize:function(size){},destroy:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)},createTimer:function(){var self=this;this.timer=setInterval(function(){self.shouldRefresh()&&self.refresh()},this.checkInterval)},setStart:function(start){this.start=start,this.refresh()},setEnd:function(end){this.end=end,this.refresh()},refresh:function(){var self=this,timeSpan=this.getTimeSpan();this.queryInProgress=!0,this.onBeforeQuery(),this.dataSource.query(timeSpan.start,timeSpan.end,this.getResolution()).then(function(results){self.queryInProgress=!1,self.lastSuccessfulQuery=Date.now(),self.onQuerySuccess(results),self.onAfterQuery()},function(reason){self.queryInProgress=!1,self.onQueryFailed(reason),self.onAfterQuery()})},shouldRefresh:function(){return this.queryInProgress?!1:0===this.refreshRate?!1:this.lastSuccessfulQuery<=Date.now()-this.refreshRate},getTimeSpan:function(){var timeSpan={};return this.last>0?(timeSpan.end=Date.now(),timeSpan.start=timeSpan.end-this.last):(timeSpan.end=this.end,timeSpan.start=this.start),timeSpan},getResolution:function(){return this.resolution>0?this.resolution:this.width},onInit:function(args){},onRender:function(){},onBeforeQuery:function(){},onQuerySuccess:function(results){},onQueryFailed:function(reason){console.log("Query failed with: "+reason)},onAfterQuery:function(){}}),Backshift.namespace("Backshift.Graph.C3"),Backshift.Graph.C3=Backshift.Class.create(Backshift.Graph,{defaults:function($super){return Backshift.extend($super(),{width:void 0,height:void 0,title:void 0,verticalLabel:void 0,clipboardData:void 0,exportIconSizeRatio:.05,interactive:!0,step:!1,zoom:!0})},onInit:function(){this.columns=[],this.groups=[],this.colorMap={},this.typeMap={},this.nameMap={},this.chartMessage="Loading...",this.clipboardPrimed=!1,this.exportIconSizeRatio>0&&document.addEventListener("copy",this._onClipboardCopy),this.chart=null},resize:function(size){this.width=size.width,this.height=size.height,null!==this.chart&&this.chart.resize(size)},destroy:function($super){$super(),null!==this.chart&&(this.chart=this.chart.destroy())},onRender:function(){this._updatePlot()},_shouldStack:function(k){if("area"===this.series[k].type)for(var n=this.series.length,i=k;n>i;i++)if("stack"===this.series[i].type)return 1;return"stack"===this.series[k].type},_getDisplayName:function(name){return void 0===name||null===name?null:name},_getType:function(type,shouldStack){var derivedType;return derivedType=shouldStack===!0?"area":type,this.step&&("line"===derivedType?derivedType="step":"area"===derivedType&&(derivedType="area-step")),derivedType},onQuerySuccess:function(results){var series,values,i,j,numSeries,numValues,X,Y,columnName,shouldStack,timestamps=results.columns[0];for(numSeries=this.series.length,numValues=timestamps.length,this.columns=[],X=["timestamp"],i=0;numValues>i;i++)X.push(timestamps[i]);this.columns[0]=X;var group=[];for(this.groups=[group],i=0;numSeries>i;i++){for(columnName="data"+i,series=this.series[i],values=results.columns[results.columnNameToIndex[series.metric]],Y=[columnName],j=0;numValues>j;j++)Y.push(values[j]);this.columns[i+1]=Y,this.colorMap[columnName]=series.color,this.nameMap[columnName]=this._getDisplayName(series.name),shouldStack=this._shouldStack(i),shouldStack&&group.push(columnName),this.typeMap[columnName]=this._getType(series.type,shouldStack)}this.chartMessage=null,this._updatePlot()},onQueryFailed:function($super,reason){$super(reason),this.chartMessage="Query failed."},_onToggleCsvExport:function(el){var iconColor="black";if(this.clipboardPrimed)window.backshift_c3_clipboard=void 0,this.clipboardPrimed=!1;else{iconColor="green";var i,j,csv="",numColumns=this.columns.length,numRows=numColumns>0?this.columns[0].length-1:0;for(i=0;numColumns>i;i++)0==i?csv="Timestamp":csv+=","+this.nameMap[this.columns[i][0]];for(i=1;numRows>=i;i++)for(csv+="\n",j=0;numColumns>j;j++)j>0&&(csv+=","),csv+=this.columns[j][i];window.backshift_c3_clipboard=csv,this.clipboardPrimed=!0}d3.select(el).style("fill",iconColor)},_onClipboardCopy:function(e){if(void 0!==window.backshift_c3_clipboard){var isIe=-1!=navigator.userAgent.toLowerCase().indexOf("msie")||-1!=navigator.userAgent.toLowerCase().indexOf("trident");isIe?window.clipboardData.setData("Text",window.backshift_c3_clipboard):e.clipboardData.setData("text/plain",window.backshift_c3_clipboard),e.preventDefault()}},_onRendered:function(){var self=this,svg=d3.select(this.element).select("svg"),boundingRect=svg.node().getBoundingClientRect();if(svg.select("#chart-title").remove(),null!==this.chartMessage&&svg.append("text").attr("id","chart-title").attr("x",boundingRect.width/2).attr("y",boundingRect.height/2.5).attr("text-anchor","middle").style("font-size","2.5em").text(this.chartMessage),svg.select("#export-to-csv").remove(),this.columns.length>0&&this.exportIconSizeRatio>0){var sizeInPixels=Math.min(boundingRect.width,boundingRect.height)*this.exportIconSizeRatio;svg.append("text").attr("id","export-to-csv").attr("x",boundingRect.width-sizeInPixels).attr("y",sizeInPixels).attr("font-family","FontAwesome").attr("font-size",function(d){return sizeInPixels+"px"}).text(function(d){return""}).on("click",function(){return self._onToggleCsvExport(this,self)})}},_updatePlot:function(){var self=this;this.chart=c3.generate({bindto:d3.select(this.element),interaction:{enabled:this.interactive},data:{x:"timestamp",columns:this.columns,types:this.typeMap,names:this.nameMap,colors:this.colorMap,groups:this.groups,order:null},size:{width:this.width,height:this.height},axis:{x:{type:"timeseries",tick:{culling:{max:8}}},y:{label:this.verticalLabel,tick:{format:d3.format(".2s")}}},grid:{x:{show:!0},y:{show:!0}},transition:{duration:0},point:{show:!1},zoom:{enabled:this.zoom},onrendered:function(){self._onRendered()},title:{text:this.title},tooltip:{format:{title:function(d){return d},value:function(value,ratio,id){return d3.format(".4s")(value)}}}})}}),Backshift.namespace("Backshift.DataSource"),Backshift.DataSource=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(args){(void 0===args.metrics||0===args.metrics.length)&&Backshift.fail("DataSource needs one or more metrics."),this.metrics=args.metrics,this.configure(args),this.onInit(args)},defaults:function(){return{}},query:function(start,end,resolution,args){},onInit:function(args){}}),Backshift.namespace("Backshift.DataSource.OpenNMS"),Backshift.DataSource.OpenNMS=Backshift.Class.create(Backshift.DataSource,{defaults:function($super){return Backshift.extend($super(),{url:"http://127.0.0.1:8980/opennms/rest/measurements",username:null,password:null})},query:function(start,end,resolution,args){var withCredentials=null!==this.username&&null!==this.password,headers={};withCredentials&&(headers.Authorization="Basic "+window.btoa(this.username+":"+this.password));var self=this,dfd=jQuery.Deferred();return jQuery.ajax({url:self.url,xhrFields:{withCredentials:withCredentials},headers:headers,type:"POST",data:JSON.stringify(self._getQueryRequest(start,end,resolution)),contentType:"application/json",dataType:"json",success:function(json){dfd.resolve(self._parseResponse(json))},error:function(jqXhr,textStatus){dfd.reject(textStatus)}}),dfd.promise()},_getQueryRequest:function(start,end,resolution){var qrSource,queryRequest={start:start,end:end,step:resolution>0?Math.floor((end-start)/resolution):1,source:[],expression:[]},timeDeltaInSeconds=end-start;return Backshift.keys(this.metrics).forEach(function(key){var metric=this.metrics[key];void 0!==metric.resourceId?(qrSource={aggregation:metric.aggregation,attribute:metric.attribute,label:metric.name,resourceId:metric.resourceId,"transient":metric["transient"]},queryRequest.source.push(qrSource)):(qrSource={value:metric.expression,label:metric.name,"transient":metric["transient"]},qrSource.value=qrSource.value.replace("{diffTime}",timeDeltaInSeconds),queryRequest.expression.push(qrSource))},this),0===queryRequest.source.length&&delete queryRequest.source,0===queryRequest.expression.length&&delete queryRequest.expression,queryRequest},_parseResponse:function(json){var k,columns,columnNames,columnNameToIndex,numMetrics=json.labels.length;for(columns=new Array(1+numMetrics),columnNames=new Array(1+numMetrics),columnNameToIndex={},columns[0]=json.timestamps,columnNames[0]="timestamp",columnNameToIndex.timestamp=0,k=0;numMetrics>k;k++)columns[1+k]=json.columns[k].values,columnNames[1+k]=json.labels[k],columnNameToIndex[columnNames[1+k]]=1+k;return{columns:columns,columnNames:columnNames,columnNameToIndex:columnNameToIndex}}}),jQuery(document).trigger("libraryLoaded","backshift");